<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aquarius V2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
      }
    </script>

    <style>
        :root {
            --primary-color: #2563eb; /* Blue 600 */
            --secondary-color: #db2777; /* Pink 600 */
            --warning-color: #f59e0b; /* Amber 500 */
            --danger-color: #dc2626; /* Red 600 */
            --bg-color: #f1f5f9; /* Slate 100 */
            --text-color: #1e293b; /* Slate 800 */
            --border-color: rgba(30, 41, 59, 0.2);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }
        
        h1, h2, h3, h4, h5, h6, .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .font-tech-mono {
            font-family: 'Share Tech Mono', monospace;
        }

        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            opacity: 0.5;
        }

        /* --- Modern UI Frame --- */
        .ui-frame {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem; /* Smoother corners */
            box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .ui-frame.no-padding { padding: 0; }

        /* --- UI Elements --- */
        .form-input {
            background: rgba(226, 232, 240, 0.7); /* slate-200 */
            border: 2px solid transparent;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .primary-btn {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
            transition: all 0.3s ease;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px -5px var(--primary-color);
        }
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px var(--primary-color);
        }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .secondary-btn {
            font-family: 'Orbitron', sans-serif;
            background-color: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            border-radius: 0.75rem;
        }
        .secondary-btn:hover:not(:disabled) { background-color: rgba(0,0,0,0.05); border-color: var(--text-color); }
        .secondary-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px var(--glow-color, rgba(245, 158, 11, 0.5)); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0)); }
            100% { box-shadow: 0 0 0 0px rgba(245, 158, 11, 0)); }
        }
        .pulse-announcement {
            animation: pulse-border 2s infinite;
        }

    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        // Three.js background setup
        import * as THREE from 'three';
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg-canvas'),
            alpha: true,
            antialias: true,
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.z = 5;

        const particleCount = 5000;
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        const color = new THREE.Color();

        for (let i = 0; i < particleCount; i++) {
            const x = (Math.random() - 0.5) * 10;
            const y = (Math.random() - 0.5) * 10;
            const z = (Math.random() - 0.5) * 10;
            positions[i * 3] = x;
            positions[i * 3 + 1] = y;
            positions[i * 3 + 2] = z;

            // Use a brighter color palette
            const randomColor = Math.random();
            if (randomColor > 0.66) color.set(0x2563eb); // Blue
            else if (randomColor > 0.33) color.set(0xdb2777); // Pink
            else color.set(0x4ade80); // Green
            
            colors[i * 3] = color.r;
            colors[i * 3 + 1] = color.g;
            colors[i * 3 + 2] = color.b;
        }

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({
            size: 0.02,
            vertexColors: true,
            transparent: true,
            opacity: 0.8,
            depthWrite: false
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX - window.innerWidth / 2) / 1000;
            mouseY = (event.clientY - window.innerHeight / 2) / 1000;
        });

        const clock = new THREE.Clock();
        const animate = () => {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();
            particles.rotation.y = elapsedTime * 0.1;
            particles.rotation.x = elapsedTime * 0.05;
            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;
            camera.lookAt(scene.position);
            renderer.render(scene, camera);
        };
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <script type="text/babel" data-type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, orderBy, query, serverTimestamp, addDoc, updateDoc, writeBatch, getDocs, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        // NEW: Import Firebase Storage
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        
        const { useState, useEffect, useRef, Fragment } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
            authDomain: "long-bao-tool-ai.firebaseapp.com",
            projectId: "long-bao-tool-ai",
            storageBucket: "long-bao-tool-ai.appspot.com",
            messagingSenderId: "259613170671",
            appId: "1:259613170671:web:55291d0b0af4e69052b41a",
            measurementId: "G-7V7H3JWX7K",
            databaseURL: "https://long-bao-tool-ai-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        const ADMIN_USERNAME = "admin";
        const DUMMY_DOMAIN = "@long-bao-tool-ai.web.app";

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const storage = getStorage(app); // NEW: Initialize Storage

        // --- GLOBAL CONSTANTS ---
        const BACARAT_TABLES = ["BACARAT C04", "BACARAT C05", "BACARAT C06", "BACARAT C07", "BACARAT C01", "BACARAT C02", "BACARAT C03", "BACARAT C08", "BACARAT C09", "BACARAT C10", "BACARAT 1", "BACARAT 2", "BACARAT 3", "BACARAT 4", "BACARAT 5", "BACARAT 7", "BACARAT 8", "BACARAT 9", "BACARAT 10", "BACARAT C11", "BACARAT C12", "BACARAT C13", "BACARAT C15"];
        const MAX_ENERGY = 100;
        
        // --- SOUND FX (No changes) ---
        const sfx = {
            boot: () => new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("C3", "8n"),
            typing: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.1, sustain: 0 } }).toDestination(),
            confirm: () => new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease("C5", "8n"),
            logout: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.2 } }).toDestination().triggerAttackRelease("C4", "4n"),
            error: () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0 } }).toDestination().triggerAttackRelease("8n"),
            notification: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("G5", "16n", Tone.now() + 0.1).triggerAttackRelease("C6", "16n", Tone.now() + 0.2),
        };

        // --- HELPER COMPONENTS & HOOKS ---
        const AnimatedPresence = ({ isVisible, children }) => {
            const [shouldRender, setShouldRender] = useState(isVisible);
            useEffect(() => {
                if (isVisible) setShouldRender(true);
                else { const timer = setTimeout(() => setShouldRender(false), 500); return () => clearTimeout(timer); }
            }, [isVisible]);
            if (!shouldRender) return null;
            return React.cloneElement(children, { className: `${children.props.className || ''} ${isVisible ? 'fade-in' : 'fade-out'}` });
        };
        
        const Modal = ({ children, onClose, size = 'md' }) => (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 fade-in" onClick={onClose}>
                <div className={`w-full max-w-${size} ui-frame`} onClick={e => e.stopPropagation()}>{children}</div>
            </div>
        );
        
        //================================================================================
        // COMPONENT: LoginScreen
        //================================================================================
        const LoginScreen = () => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true); setError('');
                await Tone.start();
                const email = username.trim().toLowerCase() + DUMMY_DOMAIN;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    setError("Xác thực thất bại. Vui lòng kiểm tra lại.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleSignup = async () => {
                setIsLoading(true); setError('');
                await Tone.start();
                const processedUsername = username.trim().toLowerCase();
                if (!processedUsername || !password) { sfx.error(); setError("Vui lòng nhập đủ thông tin."); setIsLoading(false); return; }
                if (password.length < 6) { sfx.error(); setError("Mật khẩu phải có ít nhất 6 ký tự."); setIsLoading(false); return; }
                
                const email = processedUsername + DUMMY_DOMAIN;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, "users", userCredential.user.uid);
                    await setDoc(userDocRef, {
                        uid: userCredential.user.uid, 
                        username: processedUsername, 
                        createdAt: serverTimestamp(),
                        energy: 7, 
                        hasSubmittedInfo: false, 
                        lastBlessingTimestamp: null, 
                        lastLoanRequestTimestamp: null,
                        messageCountToday: 0,
                        lastMessageDate: ""
                    });
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    if (err.code === 'auth/email-already-in-use') setError("Mã hiệu này đã được sử dụng.");
                    else setError("Không thể tạo tài khoản mới.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md ui-frame">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-black text-[var(--text-color)] font-orbitron">AQUARIUS V2</h1>
                            <p className="text-[var(--primary-color)] tracking-[0.2em] font-bold font-tech-mono">SIÊU TRÍ TUỆ</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <input value={username} onChange={e => setUsername(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="text" placeholder="Mã hiệu Pilot" className="w-full form-input font-tech-mono" />
                            <input value={password} onChange={e => setPassword(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="password" placeholder="Mật khẩu" className="w-full form-input font-tech-mono" />
                            {error && <p className="text-red-600 text-center text-sm font-semibold">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full primary-btn">
                                {isLoading ? 'ĐANG KẾT NỐI...' : 'KẾT NỐI'}
                            </button>
                        </form>
                        <div className="text-center mt-6">
                            <button onClick={handleSignup} disabled={isLoading} className="font-semibold text-[var(--primary-color)] hover:text-blue-800 text-sm font-tech-mono">
                               Chưa có tài khoản? Khởi tạo
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        //================================================================================
        // COMPONENT: UserView
        //================================================================================
        const UserView = ({ currentUser, onLogout }) => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [userData, setUserData] = useState(null);
            const [showBlessingModal, setShowBlessingModal] = useState(false);
            const [showLoanModal, setShowLoanModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showImageModal, setShowImageModal] = useState(null); // NEW: For viewing images
            const [plea, setPlea] = useState('');
            const [loanFormData, setLoanFormData] = useState({ accountName: '', amount: '' });
            const [infoFormData, setInfoFormData] = useState({ f168Account: '', capital: '', target: '' });
            const [isAdminTyping, setIsAdminTyping] = useState(false);
            const [blessingCooldown, setBlessingCooldown] = useState("");
            const [loanCooldown, setLoanCooldown] = useState("");
            const [isSending, setIsSending] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isAdminTyping]);
            
            // Notification and Cooldown Hooks (No changes)
            useEffect(() => { if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") { Notification.requestPermission(); } }, []);
            const useCooldownTimer = (lastTimestamp, setCooldownString) => {
                 useEffect(() => {
                    if (!userData || !lastTimestamp) { setCooldownString(""); return; }
                    const interval = setInterval(() => {
                        const now = Date.now();
                        const lastTime = lastTimestamp.toMillis();
                        const twentyFourHours = 24 * 60 * 60 * 1000;
                        const timePassed = now - lastTime;
                        if (timePassed < twentyFourHours) {
                            const timeLeft = twentyFourHours - timePassed;
                            const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                            const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                            const seconds = Math.floor((timeLeft / 1000) % 60);
                            setCooldownString(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                        } else { setCooldownString(""); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                }, [userData, lastTimestamp]);
            }
            useCooldownTimer(userData?.lastBlessingTimestamp, setBlessingCooldown);
            useCooldownTimer(userData?.lastLoanRequestTimestamp, setLoanCooldown);
            useEffect(() => {
                if (!currentUser || !userData) return;
                const todayStr = new Date().toISOString().split('T')[0];
                if (userData.lastMessageDate !== todayStr) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    updateDoc(userDocRef, { messageCountToday: 0, lastMessageDate: todayStr });
                }
            }, [currentUser, userData]);

            // Data fetching useEffect (No changes, just works)
            useEffect(() => {
                if (!currentUser) return;
                const userDocRef = doc(db, 'users', currentUser.uid);
                const unsubUser = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setUserData(data);
                        if(data.hasSubmittedInfo !== true) setShowInfoModal(true);
                    }
                });
                const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                const q = query(messagesColRef, orderBy('timestamp'));
                const unsubMessages = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const newMessage = change.doc.data();
                            if (newMessage.senderId !== currentUser.uid) {
                                sfx.notification();
                                if (document.hidden && Notification.permission === "granted") {
                                    new Notification("Tin nhắn mới từ Aquarius V2", {
                                        body: newMessage.text || "Bạn có một tin nhắn mới.",
                                        icon: "https://placehold.co/96x96/2563eb/white?text=A"
                                    });
                                }
                            }
                        }
                    });
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const typingRef = ref(rtdb, `typing_status/${currentUser.uid}`);
                const unsubTyping = onValue(typingRef, (snapshot) => setIsAdminTyping(snapshot.val()?.isTyping || false));
                return () => { unsubUser(); unsubMessages(); unsubTyping(); };
            }, [currentUser]);

            // Handle Send Message (No changes in logic)
            const handleSendMessage = async () => {
                const content = inputMessage.trim();
                if (content === '' || isSending || !userData) return;
                setIsSending(true);
                const userDocRef = doc(db, 'users', currentUser.uid);
                const messageCount = userData.messageCountToday || 0;
                const isFree = messageCount < 2;
                const canAfford = userData.energy >= 7;

                if (!isFree && !canAfford) {
                    sfx.error();
                    const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                    await addDoc(messagesColRef, { type: 'warning', content: { text: 'Không đủ năng lượng để gửi tin nhắn.' }, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp() });
                    setIsSending(false);
                    return;
                }
                sfx.confirm();
                try {
                    const username = currentUser.email.split('@')[0];
                    const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                    await addDoc(messagesColRef, { type: 'text', text: content, senderId: currentUser.uid, timestamp: serverTimestamp() });
                    await setDoc(doc(db, 'user_chats', currentUser.uid), { lastUpdate: serverTimestamp(), username: username, userId: currentUser.uid, isRead: false }, { merge: true });
                    const updates = { messageCountToday: increment(1) };
                    if (!isFree) { updates.energy = increment(-7); }
                    await updateDoc(userDocRef, updates);
                    setInputMessage('');
                } catch (error) { console.error("Error sending message:", error); sfx.error(); } 
                finally { setIsSending(false); }
            };
            
            // Other handlers (Blessing, Loan, Info) - No changes
            const handleBlessingRequest = async () => { /* ... no changes ... */ };
            const handleLoanRequest = async () => { /* ... no changes ... */ };
            const handleInfoSubmit = async () => { /* ... no changes ... */ };

            if (!userData) return null;
            
            // --- UI COMPONENTS ---
            const MessageBubble = ({ children, isUser, className }) => {
                const style = {
                    background: isUser
                        ? 'linear-gradient(135deg, #e0f2fe, #dbeafe)' // light sky, light blue
                        : 'linear-gradient(135deg, #ffffff, #f1f5f9)', // white, slate-100
                    border: '1px solid var(--border-color)',
                };
                return <div className={`p-3 rounded-2xl ${isUser ? 'rounded-br-lg' : 'rounded-bl-lg'} ${className}`} style={style}>{children}</div>
            }

            const TypingIndicator = () => (
                <div className="flex mb-4 justify-start">
                    <MessageBubble isUser={false}>
                        <div className="flex items-center space-x-1">
                           <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                           <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                           <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
                        </div>
                    </MessageBubble>
                </div>
            );
            
            const EnergyBar = ({ current, max }) => {
                const percentage = Math.min(100, (current / max) * 100);
                return (
                     <div className="w-full">
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-sm font-bold text-[var(--primary-color)]">NĂNG LƯỢNG</span>
                            <span className="text-sm font-bold text-slate-600">{current} / {max}</span>
                        </div>
                        <div className="w-full bg-slate-200 rounded-full h-2.5">
                            <div 
                                className="bg-gradient-to-r from-blue-500 to-cyan-400 h-2.5 rounded-full transition-all duration-500"
                                style={{ width: `${percentage}%` }}
                            ></div>
                        </div>
                    </div>
                );
            };

            const MessageRenderer = ({ msg }) => {
                const isUser = msg.senderId === currentUser.uid;
                
                const renderContent = () => {
                    switch(msg.type) {
                        // NEW: Image message type
                        case 'image': return (
                            <img 
                                src={msg.content.url} 
                                alt="Hình ảnh được gửi" 
                                className="max-w-xs md:max-w-sm rounded-lg cursor-pointer transition hover:opacity-80"
                                onClick={() => setShowImageModal(msg.content.url)}
                                onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x300/f87171/white?text=Lỗi+Ảnh'; }}
                            />
                        );
                        case 'blessing': return (<div className="p-4 border-2 border-[var(--secondary-color)] rounded-lg text-center space-y-1 shadow-lg shadow-pink-500/20"><p className="text-lg font-bold text-slate-800 uppercase tracking-widest">Lời Ban Phước</p><p><span className="font-semibold text-[var(--secondary-color)]">Bàn:</span> {msg.content.table}</p><p><span className="font-semibold text-[var(--secondary-color)]">Kết quả:</span> {msg.content.side}</p><p><span className="font-semibold text-[var(--secondary-color)]">Tay thứ:</span> {msg.content.hand}</p></div>);
                        case 'info_submission': return (<div className="space-y-1 text-sm"><p className="font-bold text-center text-[var(--primary-color)]">BÁO CÁO KHỞI TẠO</p><p>Tài khoản F168: {msg.content.f168Account}</p><p>Số vốn: {msg.content.capital}</p><p>Mục tiêu: {msg.content.target}</p></div>);
                        case 'loan_request_details': return <p className="text-amber-600 italic text-center">-- {msg.content.requestText} (Tài khoản: {msg.content.accountName}, Số tiền: {msg.content.amount}) --</p>;
                        case 'baccarat_result': return <div className={`flex items-center justify-center w-24 h-24 rounded-full border-4 shadow-lg`} style={{backgroundColor: msg.content.color, borderColor: 'white', color: 'white', textShadow: '0 1px 3px rgba(0,0,0,0.3)'}}><span className="text-6xl font-black">{msg.content.result}</span></div>;
                        case 'table_announcement': return <div className="p-4 border-2 border-[var(--warning-color)] bg-amber-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--warning-color)'}}><h4 className="text-xl font-bold text-[var(--warning-color)] uppercase tracking-widest">THÔNG BÁO BÀN</h4><p className="text-2xl font-bold text-slate-800">{msg.content.text}</p></div>;
                        case 'warning': return <div className="p-4 border-2 border-[var(--danger-color)] bg-red-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--danger-color)'}}><h4 className="text-xl font-bold text-[var(--danger-color)] uppercase tracking-widest">CẢNH BÁO</h4><p className="text-xl font-semibold text-slate-800">{msg.content.text}</p></div>;
                        case 'wait_message': return <p className="text-cyan-600 italic text-center">-- {msg.content.text} --</p>;
                        default: return <p className="text-slate-800 text-lg whitespace-pre-wrap">{msg.text}</p>;
                    }
                };
                
                const isSpecialMessage = ['baccarat_result', 'table_announcement', 'wait_message', 'loan_request_details', 'warning'].includes(msg.type);

                if (isSpecialMessage) {
                    return <div className="flex justify-center my-4">{renderContent()}</div>;
                }

                return (
                    <div className={`flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`}>
                        <div className="max-w-lg">
                            <MessageBubble isUser={isUser}>{renderContent()}</MessageBubble>
                        </div>
                    </div>
                );
            };

            const sendDisabled = isSending || ((userData?.messageCountToday || 0) >= 2 && userData.energy < 7);

            return (
                <Fragment>
                    <div className="h-screen w-screen flex items-center justify-center p-4">
                        <div className="w-full h-full max-w-4xl ui-frame flex flex-col overflow-hidden">
                            <header className="flex justify-between items-center p-4 flex-shrink-0 border-b border-[var(--border-color)] space-x-4">
                                <div className="flex-1">
                                    <h2 className="text-xl font-bold text-slate-800">PILOT: {currentUser.email.split('@')[0].toUpperCase()}</h2>
                                    <EnergyBar current={userData.energy} max={MAX_ENERGY} />
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => setShowLoanModal(true)} disabled={!!loanCooldown} className="secondary-btn px-4 py-2 text-sm disabled:opacity-50" >{loanCooldown ? <span className="font-tech-mono text-xs">{loanCooldown}</span> : 'Ứng tiền'}</button>
                                    <button onClick={onLogout} className="secondary-btn px-4 py-2">Ngắt kết nối</button>
                                </div>
                            </header>
                            
                            <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                               {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} />)}
                               {isAdminTyping && <TypingIndicator />}
                               <div ref={messagesEndRef} />
                            </main>

                            <footer className="p-4 flex-shrink-0 border-t border-[var(--border-color)] space-y-2">
                                <div className="flex items-center space-x-4">
                                    <button onClick={() => setShowBlessingModal(true)} disabled={!!blessingCooldown} className="primary-btn px-4 disabled:opacity-50" style={{'--primary-color': 'var(--secondary-color)'}}>
                                        {blessingCooldown ? <span className="font-tech-mono text-xs">{blessingCooldown}</span> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>}
                                    </button>
                                    <input value={inputMessage} onChange={e => setInputMessage(e.target.value)} onKeyPress={e => { sfx.typing.triggerAttack("C2"); if(e.key === 'Enter' && !sendDisabled) handleSendMessage() }} type="text" placeholder="Gửi tín hiệu..." className="w-full form-input" />
                                    <button onClick={handleSendMessage} disabled={sendDisabled} className="primary-btn px-6">
                                        {isSending ? '...' : 'Gửi'}
                                    </button>
                                </div>
                                <div className="text-center text-xs font-tech-mono text-slate-500 h-4">
                                    { (userData?.messageCountToday || 0) < 2
                                        ? `Lượt gửi miễn phí còn lại: ${2 - (userData?.messageCountToday || 0)}`
                                        : `Mỗi lần gửi tốn 7 năng lượng`
                                    }
                                </div>
                            </footer>
                        </div>
                    </div>
                    
                    {/* Modals (No major changes, just styling) */}
                    <AnimatedPresence isVisible={showBlessingModal}>
                        <Modal onClose={() => setShowBlessingModal(false)}>
                            <h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Thỉnh Cầu Ban Phước</h3>
                             <p className="text-center text-sm text-slate-500 mb-4">Chức năng này được dùng 1 lần mỗi 24 giờ và không tốn năng lượng.</p>
                            <textarea value={plea} onChange={e => setPlea(e.target.value)} className="w-full h-24 p-3 form-input" placeholder="Viết lời thỉnh cầu của bạn..."></textarea>
                            <div className="flex justify-end space-x-4 mt-4">
                                <button onClick={() => setShowBlessingModal(false)} className="secondary-btn px-4 py-2">Hủy</button>
                                <button onClick={handleBlessingRequest} disabled={!plea.trim() || !!blessingCooldown} className="primary-btn px-4 py-2">Gửi</button>
                            </div>
                        </Modal>
                    </AnimatedPresence>
                     <AnimatedPresence isVisible={showInfoModal}>
                         <Modal onClose={() => {}}>
                            <h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Yêu Cầu Khai Báo</h3>
                            <div className="space-y-4">
                                <input value={infoFormData.f168Account} onChange={e => setInfoFormData({...infoFormData, f168Account: e.target.value})} type="text" placeholder="Tên TK F168" className="w-full form-input" />
                                <input value={infoFormData.capital} onChange={e => setInfoFormData({...infoFormData, capital: e.target.value})} type="text" placeholder="Số vốn" className="w-full form-input" />
                                <input value={infoFormData.target} onChange={e => setInfoFormData({...infoFormData, target: e.target.value})} type="text" placeholder="Muốn lên bao nhiêu" className="w-full form-input" />
                            </div>
                            <div className="flex justify-end mt-6">
                                <button onClick={handleInfoSubmit} className="primary-btn w-full">Gửi Báo Cáo</button>
                            </div>
                        </Modal>
                    </AnimatedPresence>
                    {/* NEW: Image Viewer Modal */}
                    <AnimatedPresence isVisible={!!showImageModal}>
                        <Modal onClose={() => setShowImageModal(null)} size="3xl">
                           <img src={showImageModal} className="w-full h-auto max-h-[80vh] object-contain rounded-lg"/>
                           <div className="text-center mt-4">
                               <button onClick={() => setShowImageModal(null)} className="primary-btn">Đóng</button>
                           </div>
                        </Modal>
                    </AnimatedPresence>
                </Fragment>
            );
        };

        //================================================================================
        // COMPONENT: AdminDashboard
        //================================================================================
        const AdminDashboard = ({ currentUser, onLogout }) => {
            const [conversations, setConversations] = useState([]);
            const [currentChat, setCurrentChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [editingMessage, setEditingMessage] = useState({ id: null, text: '' });
            const [uploadingImage, setUploadingImage] = useState(false); // NEW: Image upload state
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);
            const imageInputRef = useRef(null); // NEW: Ref for file input

            // Hooks for conversations, messages, typing (No changes)
            useEffect(() => {
                const q = query(collection(db, 'user_chats'), orderBy('lastUpdate', 'desc'));
                const unsub = onSnapshot(q, snapshot => setConversations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, []);
            useEffect(() => {
                if (!currentChat) return;
                const messagesColRef = collection(db, 'user_chats', currentChat.id, 'messages');
                const q = query(messagesColRef, orderBy('timestamp'));
                const unsub = onSnapshot(q, snapshot => setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, [currentChat]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);
            const handleTyping = (e) => { /* ... no changes ... */ };

            // --- NEW: Image Upload Handler ---
            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (!file || !currentChat) return;
                if (!file.type.startsWith('image/')) {
                    alert('Vui lòng chỉ chọn file ảnh!');
                    return;
                }
                setUploadingImage(true);
                try {
                    const filePath = `chat_images/${currentChat.id}/${Date.now()}_${file.name}`;
                    const fileRef = storageRef(storage, filePath);
                    const uploadTask = uploadBytesResumable(fileRef, file);
                    
                    uploadTask.on('state_changed', 
                        (snapshot) => { /* Can be used for progress bar */ }, 
                        (error) => {
                            console.error("Upload failed:", error);
                            sfx.error();
                            setUploadingImage(false);
                        }, 
                        () => {
                            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                                handleSendMessage('image', { url: downloadURL });
                                setUploadingImage(false);
                            });
                        }
                    );
                } catch (error) {
                    console.error("Error uploading image:", error);
                    sfx.error();
                    setUploadingImage(false);
                }
                // Reset file input
                event.target.value = null;
            };

            const handleSendMessage = async (type = 'text', content = null) => {
                if (!currentChat) return;
                const text = content && content.text ? content.text : inputMessage.trim();
                if (text === '' && type === 'text') return;
                
                sfx.confirm();
                const messagesColRef = collection(db, 'user_chats', currentChat.id, 'messages');
                await addDoc(messagesColRef, {
                    type: type,
                    text: type === 'text' ? text : null,
                    content: type !== 'text' ? content : null,
                    senderId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, 'user_chats', currentChat.id), { lastUpdate: serverTimestamp(), isRead: true });
                if (type === 'text') setInputMessage('');
            };
            
            // Edit/Save handlers (No changes)
            const handleStartEdit = (msg) => setEditingMessage({ id: msg.id, text: msg.text });
            const handleSaveEdit = async () => { /* ... no changes ... */ };

            const MessageRenderer = ({ msg }) => {
                const isUserMessage = msg.senderId !== currentUser.uid;
                const isEditing = editingMessage.id === msg.id;

                if (isEditing) { /* ... no changes ... */ }
                
                const renderContent = () => {
                    switch(msg.type) {
                        // NEW: Render image in admin panel
                        case 'image': return (
                            <img 
                                src={msg.content.url} 
                                alt="Hình ảnh được gửi" 
                                className="max-w-xs md:max-w-sm rounded-lg"
                                onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x300/f87171/white?text=Lỗi+Ảnh'; }}
                            />
                        );
                        case 'loan_request_details': return <p className="text-amber-600 italic text-center">-- {msg.content.requestText} (Tài khoản: {msg.content.accountName}, Số tiền: {msg.content.amount}) --</p>;
                        case 'baccarat_result': return <div className={`flex items-center justify-center w-24 h-24 rounded-full border-4 shadow-lg`} style={{backgroundColor: msg.content.color, borderColor: 'white', color: 'white', textShadow: '0 1px 3px rgba(0,0,0,0.3)'}}><span className="text-6xl font-black">{msg.content.result}</span></div>;
                        case 'table_announcement': return <div className="p-4 border-2 border-[var(--warning-color)] bg-amber-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--warning-color)'}}><h4 className="text-xl font-bold text-[var(--warning-color)] uppercase tracking-widest">THÔNG BÁO BÀN</h4><p className="text-2xl font-bold text-slate-800">{msg.content.text}</p></div>;
                        case 'warning': return <div className="p-4 border-2 border-[var(--danger-color)] bg-red-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--danger-color)'}}><h4 className="text-xl font-bold text-[var(--danger-color)] uppercase tracking-widest">CẢNH BÁO</h4><p className="text-xl font-semibold text-slate-800">{msg.content.text}</p></div>;
                        case 'wait_message': return <p className="text-cyan-600 italic text-center">-- {msg.content.text} --</p>;
                        default: return <p className="text-slate-800 text-lg whitespace-pre-wrap">{msg.text || JSON.stringify(msg.content)}</p>;
                    }
                };
                
                const isSpecialMessage = ['baccarat_result', 'table_announcement', 'wait_message', 'loan_request_details', 'warning'].includes(msg.type);
                if (isSpecialMessage) return <div className="flex justify-center my-4">{renderContent()}</div>;
                
                const isEditable = msg.type === 'text' || (!msg.type && msg.text);

                return (
                     <div className={`group flex items-end gap-2 my-2 ${!isUserMessage ? 'justify-end' : 'justify-start'}`}>
                        <div className="max-w-lg">
                             <div className="p-3 rounded-2xl" style={{
                                background: !isUserMessage ? 'linear-gradient(135deg, #2563eb, #3b82f6)' : 'linear-gradient(135deg, #ffffff, #f1f5f9)',
                                color: !isUserMessage ? 'white' : 'var(--text-color)',
                                border: '1px solid var(--border-color)',
                                borderRadius: !isUserMessage ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'
                             }}>
                                {renderContent()}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                 <div className="h-screen w-screen flex items-center justify-center p-4">
                    <div className="w-full h-full max-w-7xl ui-frame no-padding flex overflow-hidden">
                        {/* Conversation List */}
                        <div className="w-1/3 border-r border-[var(--border-color)] flex flex-col">
                            <header className="p-4 border-b border-[var(--border-color)] flex-shrink-0 flex justify-between items-center">
                                <h2 className="text-xl font-bold text-slate-800">Bảng điều khiển</h2>
                                <button onClick={onLogout} className="secondary-btn px-3 py-1.5 text-sm">Đăng xuất</button>
                            </header>
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                {conversations.map(conv => (
                                    <div 
                                        key={conv.id} 
                                        onClick={() => setCurrentChat(conv)}
                                        className={`p-4 cursor-pointer border-b border-slate-200 flex justify-between items-center transition-colors duration-200 ${currentChat?.id === conv.id ? 'bg-blue-100' : 'hover:bg-slate-100'}`}
                                    >
                                        <div>
                                            <p className="font-semibold text-slate-800 text-lg">{conv.username}</p>
                                            <p className="text-xs text-slate-500">ID: {conv.id.slice(0, 8)}...</p>
                                        </div>
                                        {conv.isRead === false && <div className="w-3 h-3 bg-blue-500 rounded-full shadow-lg shadow-blue-500/50"></div>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Chat Window */}
                        <div className="w-2/3 flex flex-col bg-slate-50">
                           {currentChat ? (
                                <Fragment>
                                    <header className="p-4 border-b border-[var(--border-color)] flex-shrink-0 bg-white">
                                        <h2 className="text-xl font-bold text-slate-800">Kênh: {currentChat.username}</h2>
                                    </header>
                                    <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                                        {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} />)}
                                        <div ref={messagesEndRef} />
                                    </main>
                                    <footer className="p-4 border-t border-[var(--border-color)] flex-shrink-0 space-y-3 bg-white">
                                        {/* Quick Actions (Baccarat, etc.) can go here if needed */}
                                        <div className="flex items-center space-x-2">
                                            {/* NEW: Image upload button */}
                                            <input type="file" accept="image/*" ref={imageInputRef} onChange={handleImageUpload} style={{ display: 'none' }} />
                                            <button 
                                                onClick={() => imageInputRef.current.click()} 
                                                disabled={uploadingImage}
                                                className="secondary-btn p-2.5"
                                            >
                                                {uploadingImage ? 
                                                    <svg className="animate-spin h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                    : 
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                }
                                            </button>
                                            <input value={inputMessage} onChange={handleTyping} onKeyPress={e => { if(e.key === 'Enter') handleSendMessage() }} type="text" placeholder="Phản hồi..." className="w-full form-input" />
                                            <button onClick={() => handleSendMessage()} className="primary-btn px-6">Gửi</button>
                                        </div>
                                    </footer>
                                </Fragment>
                           ) : (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-400 space-y-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1"><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                    <p className="text-xl">Chọn một kênh liên lạc để bắt đầu</p>
                                </div>
                           )}
                        </div>
                    </div>
                </div>
            );
        };

        //================================================================================
        // TOP-LEVEL COMPONENT: System
        //================================================================================
        const System = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setCurrentUser(user);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => {
                sfx.logout();
                signOut(auth);
            };

            if (isLoading) {
                return <div className="h-screen w-screen"></div>; // Blank screen while loading
            }

            const isAdmin = currentUser && currentUser.email.split('@')[0] === ADMIN_USERNAME;

            return (
                <Fragment>
                    <AnimatedPresence isVisible={!currentUser}>
                        <LoginScreen />
                    </AnimatedPresence>
                    <AnimatedPresence isVisible={!!currentUser}>
                        <div> 
                            {isAdmin ? 
                                <AdminDashboard currentUser={currentUser} onLogout={handleLogout} /> :
                                <UserView currentUser={currentUser} onLogout={handleLogout} />
                            }
                        </div>
                    </AnimatedPresence>
                </Fragment>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<System />);
    </script>
</body>
</html>
