<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aquarius V</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
      }
    </script>

    <style>
        :root {
            --primary-color: #2563eb; /* Blue 600 */
            --secondary-color: #db2777; /* Pink 600 */
            --warning-color: #f59e0b; /* Amber 500 */
            --danger-color: #dc2626; /* Red 600 */
            --success-color: #16a34a; /* Green 600 */
            --bg-color: #f1f5f9; /* Slate 100 */
            --text-color: #1e293b; /* Slate 800 */
            --border-color: rgba(30, 41, 59, 0.2);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }
        
        h1, h2, h3, h4, h5, h6, .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .font-tech-mono {
            font-family: 'Share Tech Mono', monospace;
        }

        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            opacity: 0.5;
        }

        .ui-frame {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        .ui-frame.no-padding { padding: 0; }

        .form-input {
            background: rgba(226, 232, 240, 0.7);
            border: 2px solid transparent;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .primary-btn {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
            transition: all 0.3s ease;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px -5px var(--primary-color);
        }
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px var(--primary-color);
        }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .secondary-btn {
            font-family: 'Orbitron', sans-serif;
            background-color: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            border-radius: 0.75rem;
        }
        .secondary-btn:hover:not(:disabled) { background-color: rgba(0,0,0,0.05); border-color: var(--text-color); }
        .secondary-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        
        .pulse-announcement {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px var(--glow-color, rgba(245, 158, 11, 0.5)); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0)); }
            100% { box-shadow: 0 0 0 0px rgba(245, 158, 11, 0)); }
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        // Three.js background setup
        import * as THREE from 'three';
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg-canvas'),
            alpha: true,
            antialias: true,
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.z = 5;
        const particleCount = 1500;
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        const color = new THREE.Color();
        for (let i = 0; i < particleCount; i++) {
            const x = (Math.random() - 0.5) * 10;
            const y = (Math.random() - 0.5) * 10;
            const z = (Math.random() - 0.5) * 10;
            positions[i * 3] = x;
            positions[i * 3 + 1] = y;
            positions[i * 3 + 2] = z;
            const randomColor = Math.random();
            if (randomColor > 0.66) color.set(0x2563eb);
            else if (randomColor > 0.33) color.set(0xdb2777);
            else color.set(0x4ade80);
            colors[i * 3] = color.r;
            colors[i * 3 + 1] = color.g;
            colors[i * 3 + 2] = color.b;
        }
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: 0.025, vertexColors: true, transparent: true, opacity: 0.8, depthWrite: false });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX - window.innerWidth / 2) / 1000;
            mouseY = (event.clientY - window.innerHeight / 2) / 1000;
        });
        const clock = new THREE.Clock();
        const animate = () => {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();
            particles.rotation.y = elapsedTime * 0.1;
            particles.rotation.x = elapsedTime * 0.05;
            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;
            camera.lookAt(scene.position);
            renderer.render(scene, camera);
        };
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, orderBy, query, serverTimestamp, addDoc, updateDoc, writeBatch, getDocs, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        
        const { useState, useEffect, useRef, Fragment } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
            authDomain: "long-bao-tool-ai.firebaseapp.com",
            projectId: "long-bao-tool-ai",
            storageBucket: "long-bao-tool-ai.appspot.com",
            messagingSenderId: "259613170671",
            appId: "1:259613170671:web:55291d0b0af4e69052b41a",
            measurementId: "G-7V7H3JWX7K",
            databaseURL: "https://long-bao-tool-ai-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        const ADMIN_USERNAME = "admin";
        const DUMMY_DOMAIN = "@long-bao-tool-ai.web.app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const storage = getStorage(app);

        const BACARAT_TABLES = ["BACARAT C04", "BACARAT C05", "BACARAT C06", "BACARAT C07", "BACARAT C01", "BACARAT C02", "BACARAT C03", "BACARAT C08", "BACARAT C09", "BACARAT C10", "BACARAT 1", "BACARAT 2", "BACARAT 3", "BACARAT 4", "BACARAT 5", "BACARAT 7", "BACARAT 8", "BACARAT 9", "BACARAT 10", "BACARAT C11", "BACARAT C12", "BACARAT C13", "BACARAT C15"];
        const MAX_ENERGY = 100;
        
        const sfx = {
            boot: () => new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("C3", "8n"),
            typing: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.1, sustain: 0 } }).toDestination(),
            confirm: () => new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease("C5", "8n"),
            logout: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.2 } }).toDestination().triggerAttackRelease("C4", "4n"),
            error: () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0 } }).toDestination().triggerAttackRelease("8n"),
            notification: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("G5", "16n", Tone.now() + 0.1).triggerAttackRelease("C6", "16n", Tone.now() + 0.2),
            blessing: () => new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.2, decay: 0.3, sustain: 0.5, release: 0.5 } }).toDestination().triggerAttackRelease("A4", "2n"),
            reaction: () => new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination().triggerAttackRelease("A5", "16n"),
        };

        const AnimatedPresence = ({ isVisible, children }) => {
            const [shouldRender, setShouldRender] = useState(isVisible);
            useEffect(() => {
                if (isVisible) setShouldRender(true);
                else { const timer = setTimeout(() => setShouldRender(false), 500); return () => clearTimeout(timer); }
            }, [isVisible]);
            if (!shouldRender) return null;
            return React.cloneElement(children, { className: `${children.props.className || ''} ${isVisible ? 'fade-in' : 'fade-out'}` });
        };
        
        const Modal = ({ children, onClose, size = 'md' }) => (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 fade-in" onClick={onClose}>
                <div className={`w-full max-w-${size} ui-frame`} onClick={e => e.stopPropagation()}>{children}</div>
            </div>
        );
        
        const LoginScreen = () => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true); setError('');
                await Tone.start();
                const email = username.trim().toLowerCase() + DUMMY_DOMAIN;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    setError("X√°c th·ª±c th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleSignup = async () => {
                setIsLoading(true); setError('');
                await Tone.start();
                const processedUsername = username.trim().toLowerCase();
                if (!processedUsername || !password) { sfx.error(); setError("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin."); setIsLoading(false); return; }
                if (password.length < 6) { sfx.error(); setError("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±."); setIsLoading(false); return; }
                
                const email = processedUsername + DUMMY_DOMAIN;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, "users", userCredential.user.uid);
                    await setDoc(userDocRef, {
                        uid: userCredential.user.uid, 
                        username: processedUsername, 
                        createdAt: serverTimestamp(),
                        energy: 7, 
                        hasSubmittedInfo: false, 
                        lastBlessingTimestamp: null, 
                        lastLoanRequestTimestamp: null,
                        messageCountToday: 0,
                        lastMessageDate: "",
                        avatarUrl: `https://placehold.co/96x96/e2e8f0/64748b?text=${processedUsername.charAt(0).toUpperCase()}` // Default avatar
                    });
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    if (err.code === 'auth/email-already-in-use') setError("M√£ hi·ªáu n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.");
                    else setError("Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n m·ªõi.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md ui-frame">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-black text-[var(--text-color)] font-orbitron">AQUARIUS V2.3</h1>
                            <p className="text-[var(--primary-color)] tracking-[0.2em] font-bold font-tech-mono">SI√äU TR√ç TU·ªÜ</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <input value={username} onChange={e => setUsername(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="text" placeholder="M√£ hi·ªáu Pilot" className="w-full form-input font-tech-mono" />
                            <input value={password} onChange={e => setPassword(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="password" placeholder="M·∫≠t kh·∫©u" className="w-full form-input font-tech-mono" />
                            {error && <p className="text-red-600 text-center text-sm font-semibold">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full primary-btn">
                                {isLoading ? 'ƒêANG K·∫æT N·ªêI...' : 'K·∫æT N·ªêI'}
                            </button>
                        </form>
                        <div className="text-center mt-6">
                            <button onClick={handleSignup} disabled={isLoading} className="font-semibold text-[var(--primary-color)] hover:text-blue-800 text-sm font-tech-mono">
                               Ch∆∞a c√≥ t√†i kho·∫£n? Kh·ªüi t·∫°o
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const UserView = ({ currentUser, onLogout }) => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [userData, setUserData] = useState(null);
            const [showBlessingModal, setShowBlessingModal] = useState(false);
            const [showLoanModal, setShowLoanModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showImageModal, setShowImageModal] = useState(null);
            const [plea, setPlea] = useState('');
            const [loanFormData, setLoanFormData] = useState({ accountName: '', amount: '' });
            const [infoFormData, setInfoFormData] = useState({ f168Account: '', capital: '', target: '' });
            const [isAdminTyping, setIsAdminTyping] = useState(false);
            const [blessingCooldown, setBlessingCooldown] = useState("");
            const [loanCooldown, setLoanCooldown] = useState("");
            const [isSending, setIsSending] = useState(false);
            const [isUploadingAvatar, setIsUploadingAvatar] = useState(false);
            const messagesEndRef = useRef(null);
            const avatarInputRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isAdminTyping]);
            useEffect(() => { if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") { Notification.requestPermission(); } }, []);
            
            const useCooldownTimer = (lastTimestamp, setCooldownString) => {
                 useEffect(() => {
                    if (!userData || !lastTimestamp) { setCooldownString(""); return; }
                    const interval = setInterval(() => {
                        const now = Date.now();
                        const lastTime = lastTimestamp.toMillis();
                        const twentyFourHours = 24 * 60 * 60 * 1000;
                        const timePassed = now - lastTime;
                        if (timePassed < twentyFourHours) {
                            const timeLeft = twentyFourHours - timePassed;
                            const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                            const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                            const seconds = Math.floor((timeLeft / 1000) % 60);
                            setCooldownString(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                        } else { setCooldownString(""); clearInterval(interval); }
                    }, 1000);
                    return () => clearInterval(interval);
                }, [userData, lastTimestamp]);
            }
            useCooldownTimer(userData?.lastBlessingTimestamp, setBlessingCooldown);
            useCooldownTimer(userData?.lastLoanRequestTimestamp, setLoanCooldown);
            
            useEffect(() => {
                if (!currentUser || !userData) return;
                const todayStr = new Date().toISOString().split('T')[0];
                if (userData.lastMessageDate !== todayStr) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    updateDoc(userDocRef, { messageCountToday: 0, lastMessageDate: todayStr });
                }
            }, [currentUser, userData]);

            useEffect(() => {
                if (!currentUser) return;
                const userDocRef = doc(db, 'users', currentUser.uid);
                const unsubUser = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setUserData(data);
                        if(data.hasSubmittedInfo !== true) setShowInfoModal(true);
                    }
                });
                const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                const q = query(messagesColRef, orderBy('timestamp'));
                const unsubMessages = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const newMessage = change.doc.data();
                            if (newMessage.senderId !== currentUser.uid) {
                                sfx.notification();
                                if (document.hidden && Notification.permission === "granted") {
                                    new Notification("Tin nh·∫Øn m·ªõi t·ª´ Aquarius V2.3", {
                                        body: newMessage.text || "B·∫°n c√≥ m·ªôt tin nh·∫Øn m·ªõi.",
                                        icon: "https://placehold.co/96x96/2563eb/white?text=A"
                                    });
                                }
                            }
                        }
                    });
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const typingRef = ref(rtdb, `typing_status/${currentUser.uid}`);
                const unsubTyping = onValue(typingRef, (snapshot) => setIsAdminTyping(snapshot.val()?.isTyping || false));
                return () => { unsubUser(); unsubMessages(); unsubTyping(); };
            }, [currentUser]);

            const handleSendMessage = async () => {
                const content = inputMessage.trim();
                if (content === '' || isSending || !userData) return;
                setIsSending(true);
                const userDocRef = doc(db, 'users', currentUser.uid);
                const messageCount = userData.messageCountToday || 0;
                const isFree = messageCount < 2;
                const canAfford = userData.energy >= 7;

                if (!isFree && !canAfford) {
                    sfx.error();
                    await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'warning', content: { text: 'Kh√¥ng ƒë·ªß nƒÉng l∆∞·ª£ng ƒë·ªÉ g·ª≠i tin nh·∫Øn.' }, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp() });
                    setIsSending(false);
                    return;
                }
                sfx.confirm();
                try {
                    const username = currentUser.email.split('@')[0];
                    await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'text', text: content, senderId: currentUser.uid, timestamp: serverTimestamp() });
                    await setDoc(doc(db, 'user_chats', currentUser.uid), { lastUpdate: serverTimestamp(), username: username, userId: currentUser.uid, isRead: false }, { merge: true });
                    const updates = { messageCountToday: increment(1) };
                    if (!isFree) { updates.energy = increment(-7); }
                    await updateDoc(userDocRef, updates);
                    setInputMessage('');
                } catch (error) { console.error("Error sending message:", error); sfx.error(); } 
                finally { setIsSending(false); }
            };
            
            const handleBlessingRequest = async () => { /* ... no changes ... */ };
            const handleLoanRequest = async () => { /* ... no changes ... */ };
            const handleInfoSubmit = async () => { /* ... no changes ... */ };
            const handleReaction = async (messageId, emoji) => {
                sfx.reaction();
                const messageRef = doc(db, 'user_chats', currentUser.uid, 'messages', messageId);
                await updateDoc(messageRef, { [`reactions.${emoji}`]: increment(1) });
            };

            // NEW: Handle avatar upload
            const handleAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploadingAvatar(true);
                const filePath = `avatars/${currentUser.uid}/${file.name}`;
                const fileRef = storageRef(storage, filePath);
                const uploadTask = uploadBytesResumable(fileRef, file);

                uploadTask.on('state_changed', 
                    null,
                    (error) => {
                        console.error("Avatar upload error", error);
                        sfx.error();
                        setIsUploadingAvatar(false);
                    },
                    () => {
                        getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                            await updateDoc(doc(db, "users", currentUser.uid), { avatarUrl: downloadURL });
                            setIsUploadingAvatar(false);
                            sfx.confirm();
                        });
                    }
                );
            };

            if (!userData) return null;
            
            const MessageBubble = ({ children, isUser, msg }) => {
                const reactions = msg.reactions ? Object.entries(msg.reactions).filter(([key, value]) => value > 0) : [];
                return (
                    <div className="relative group">
                        <div 
                            className={`p-3 rounded-2xl ${isUser ? 'rounded-br-lg' : 'rounded-bl-lg'}`}
                            style={{ background: isUser ? 'linear-gradient(135deg, #e0f2fe, #dbeafe)' : 'linear-gradient(135deg, #ffffff, #f1f5f9)', border: '1px solid var(--border-color)' }}
                        >
                            {children}
                        </div>
                        {reactions.length > 0 && (
                             <div className="absolute -bottom-3 right-2 flex items-center space-x-1 bg-white border border-slate-200 rounded-full px-2 py-0.5 shadow-sm">
                                {reactions.map(([emoji, count]) => ( <span key={emoji} className="text-xs">{emoji} {count}</span> ))}
                            </div>
                        )}
                        {!isUser && msg.type !== 'blessing' && (
                            <div className="absolute top-0 -right-10 hidden group-hover:flex space-x-1 bg-white p-1 rounded-full shadow-md border border-slate-200">
                                {['üëç', '‚ù§Ô∏è', 'üòÇ'].map(emoji => (
                                    <button key={emoji} onClick={() => handleReaction(msg.id, emoji)} className="text-lg hover:scale-125 transition-transform">
                                        {emoji}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                );
            }

            const TypingIndicator = () => (
                <div className="flex mb-4 justify-start">
                    <div className="p-3 rounded-2xl rounded-bl-lg" style={{ background: 'linear-gradient(135deg, #ffffff, #f1f5f9)', border: '1px solid var(--border-color)'}}>
                        <div className="flex items-center space-x-1">
                           <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                           <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                           <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                </div>
            );
            
            const EnergyBar = ({ current, max }) => {
                const percentage = Math.min(100, (current / max) * 100);
                return (
                     <div className="w-full">
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-sm font-bold text-[var(--primary-color)]">NƒÇNG L∆Ø·ª¢NG</span>
                            <span className="text-sm font-bold text-slate-600">{current} / {max}</span>
                        </div>
                        <div className="w-full bg-slate-200 rounded-full h-2.5">
                            <div className="bg-gradient-to-r from-blue-500 to-cyan-400 h-2.5 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }}></div>
                        </div>
                    </div>
                );
            };

            const BlessingHistoryModal = ({ messages, onClose }) => { /* ... no changes ... */ };

            const MessageRenderer = ({ msg }) => { /* ... no changes ... */ };

            const sendDisabled = isSending || ((userData?.messageCountToday || 0) >= 2 && userData.energy < 7);

            return (
                <Fragment>
                    <div className="h-screen w-screen flex items-center justify-center p-4">
                        <div className="w-full h-full max-w-4xl ui-frame flex flex-col overflow-hidden">
                            <header className="flex justify-between items-center p-4 flex-shrink-0 border-b border-[var(--border-color)] space-x-4">
                                <div className="flex-1 flex items-center space-x-4">
                                    {/* NEW: Avatar display and upload */}
                                    <div className="relative group">
                                        <img 
                                            src={userData.avatarUrl} 
                                            alt="Avatar" 
                                            className="w-16 h-16 rounded-full border-2 border-white shadow-md cursor-pointer"
                                            onClick={() => avatarInputRef.current.click()}
                                            onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/96x96/e2e8f0/64748b?text=${userData.username.charAt(0).toUpperCase()}`; }}
                                        />
                                        <input type="file" ref={avatarInputRef} onChange={handleAvatarUpload} accept="image/*" className="hidden" />
                                        <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                            {isUploadingAvatar ? 
                                                <svg className="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                : "ƒê·ªïi"
                                            }
                                        </div>
                                    </div>
                                    <div className="flex-1">
                                        <h2 className="text-xl font-bold text-slate-800">PILOT: {currentUser.email.split('@')[0].toUpperCase()}</h2>
                                        <EnergyBar current={userData.energy} max={MAX_ENERGY} />
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => setShowHistoryModal(true)} className="secondary-btn px-4 py-2 text-sm">L·ªãch s·ª≠</button>
                                    <button onClick={onLogout} className="secondary-btn px-4 py-2">Ng·∫Øt k·∫øt n·ªëi</button>
                                </div>
                            </header>
                            
                            <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                               {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} />)}
                               {isAdminTyping && <TypingIndicator />}
                               <div ref={messagesEndRef} />
                            </main>

                            <footer className="p-4 flex-shrink-0 border-t border-[var(--border-color)] space-y-2">
                                <div className="flex items-center space-x-4">
                                    <button onClick={() => setShowBlessingModal(true)} disabled={!!blessingCooldown} className="primary-btn px-4 disabled:opacity-50" style={{'--primary-color': 'var(--secondary-color)'}}>
                                        {blessingCooldown ? <span className="font-tech-mono text-xs">{blessingCooldown}</span> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>}
                                    </button>
                                    <input value={inputMessage} onChange={e => setInputMessage(e.target.value)} onKeyPress={e => { sfx.typing.triggerAttack("C2"); if(e.key === 'Enter' && !sendDisabled) handleSendMessage() }} type="text" placeholder="G·ª≠i t√≠n hi·ªáu..." className="w-full form-input" />
                                    <button onClick={handleSendMessage} disabled={sendDisabled} className="primary-btn px-6">
                                        {isSending ? '...' : 'G·ª≠i'}
                                    </button>
                                </div>
                                <div className="text-center text-xs font-tech-mono text-slate-500 h-4">
                                    { (userData?.messageCountToday || 0) < 2 ? `L∆∞·ª£t g·ª≠i mi·ªÖn ph√≠ c√≤n l·∫°i: ${2 - (userData?.messageCountToday || 0)}` : `M·ªói l·∫ßn g·ª≠i t·ªën 7 nƒÉng l∆∞·ª£ng` }
                                </div>
                            </footer>
                        </div>
                    </div>
                    
                    {/* Modals */}
                    <AnimatedPresence isVisible={showBlessingModal}><Modal onClose={() => setShowBlessingModal(false)}><h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Th·ªânh C·∫ßu Ban Ph∆∞·ªõc</h3><p className="text-center text-sm text-slate-500 mb-4">Ch·ª©c nƒÉng n√†y ƒë∆∞·ª£c d√πng 1 l·∫ßn m·ªói 24 gi·ªù v√† kh√¥ng t·ªën nƒÉng l∆∞·ª£ng.</p><textarea value={plea} onChange={e => setPlea(e.target.value)} className="w-full h-24 p-3 form-input" placeholder="Vi·∫øt l·ªùi th·ªânh c·∫ßu c·ªßa b·∫°n..."></textarea><div className="flex justify-end space-x-4 mt-4"><button onClick={() => setShowBlessingModal(false)} className="secondary-btn px-4 py-2">H·ªßy</button><button onClick={handleBlessingRequest} disabled={!plea.trim() || !!blessingCooldown} className="primary-btn px-4 py-2">G·ª≠i</button></div></Modal></AnimatedPresence>
                    <AnimatedPresence isVisible={showInfoModal}><Modal onClose={() => {}}><h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Y√™u C·∫ßu Khai B√°o</h3><div className="space-y-4"><input value={infoFormData.f168Account} onChange={e => setInfoFormData({...infoFormData, f168Account: e.target.value})} type="text" placeholder="T√™n TK F168" className="w-full form-input" /><input value={infoFormData.capital} onChange={e => setInfoFormData({...infoFormData, capital: e.target.value})} type="text" placeholder="S·ªë v·ªën" className="w-full form-input" /><input value={infoFormData.target} onChange={e => setInfoFormData({...infoFormData, target: e.target.value})} type="text" placeholder="Mu·ªën l√™n bao nhi√™u" className="w-full form-input" /></div><div className="flex justify-end mt-6"><button onClick={handleInfoSubmit} className="primary-btn w-full">G·ª≠i B√°o C√°o</button></div></Modal></AnimatedPresence>
                    <AnimatedPresence isVisible={showImageModal}><Modal onClose={() => setShowImageModal(null)} size="3xl"><img src={showImageModal} className="w-full h-auto max-h-[80vh] object-contain rounded-lg"/><div className="text-center mt-4"><button onClick={() => setShowImageModal(null)} className="primary-btn">ƒê√≥ng</button></div></Modal></AnimatedPresence>
                    <AnimatedPresence isVisible={showHistoryModal}><BlessingHistoryModal messages={messages} onClose={() => setShowHistoryModal(false)} /></AnimatedPresence>
                </Fragment>
            );
        };

        const AdminDashboard = ({ currentUser, onLogout }) => {
            const [conversations, setConversations] = useState([]);
            const [currentChat, setCurrentChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [editingMessage, setEditingMessage] = useState({ id: null, text: '' });
            const [uploadingImage, setUploadingImage] = useState(false);
            const [onlineUsers, setOnlineUsers] = useState([]); // NEW: State for online users
            const [showBroadcastModal, setShowBroadcastModal] = useState(false); // NEW: State for broadcast modal
            const [broadcastMessage, setBroadcastMessage] = useState(''); // NEW: State for broadcast message
            const messagesEndRef = useRef(null);
            const imageInputRef = useRef(null);

            // Fetch conversations and messages (no changes)
            useEffect(() => {
                const q = query(collection(db, 'user_chats'), orderBy('lastUpdate', 'desc'));
                const unsub = onSnapshot(q, snapshot => setConversations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, []);
            useEffect(() => {
                if (!currentChat) return;
                const q = query(collection(db, 'user_chats', currentChat.id, 'messages'), orderBy('timestamp'));
                const unsub = onSnapshot(q, snapshot => setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, [currentChat]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);
            
            // NEW: Listen for online users
            useEffect(() => {
                const statusRef = ref(rtdb, 'status');
                const unsub = onValue(statusRef, (snapshot) => {
                    const users = [];
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        if (user.isOnline) {
                            users.push({ uid: childSnapshot.key, ...user });
                        }
                    });
                    setOnlineUsers(users);
                });
                return () => unsub();
            }, []);

            const handleTyping = (e) => { /* ... no changes ... */ };
            const handleImageUpload = async (event) => { /* ... no changes ... */ };
            const handleSendMessage = async (type = 'text', content = null) => {
                if (!currentChat) return;
                const text = content && content.text ? content.text : inputMessage.trim();
                if (text === '' && type === 'text') return;
                
                sfx.confirm();
                await addDoc(collection(db, 'user_chats', currentChat.id, 'messages'), {
                    type: type, text: type === 'text' ? text : null, content: type !== 'text' ? content : null,
                    senderId: currentUser.uid, timestamp: serverTimestamp(), reactions: {}
                });
                await updateDoc(doc(db, 'user_chats', currentChat.id), { lastUpdate: serverTimestamp(), isRead: true });
                if (type === 'text') setInputMessage('');
            };
            const handleStartEdit = (msg) => { /* ... no changes ... */ };
            const handleSaveEdit = async () => { /* ... no changes ... */ };

            // NEW: Handle Broadcast Message
            const handleBroadcast = async () => {
                if (broadcastMessage.trim() === '' || onlineUsers.length === 0) return;
                sfx.confirm();
                const batch = writeBatch(db);
                onlineUsers.forEach(user => {
                    const messageRef = doc(collection(db, 'user_chats', user.uid, 'messages'));
                    batch.set(messageRef, {
                        type: 'broadcast',
                        content: { text: broadcastMessage.trim() },
                        senderId: 'AQUARIUS_SYSTEM',
                        timestamp: serverTimestamp(),
                        reactions: {}
                    });
                });
                await batch.commit();
                setBroadcastMessage('');
                setShowBroadcastModal(false);
            };

            const MessageRenderer = ({ msg }) => {
                const isUserMessage = msg.senderId !== currentUser.uid;
                const reactions = msg.reactions ? Object.entries(msg.reactions).filter(([key, value]) => value > 0) : [];
                
                const renderContent = () => {
                    switch(msg.type) {
                        case 'broadcast': return <div className="p-4 border-2 border-[var(--success-color)] bg-green-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--success-color)'}}><h4 className="text-xl font-bold text-[var(--success-color)] uppercase tracking-widest">TH√îNG B√ÅO H·ªÜ TH·ªêNG</h4><p className="text-xl font-semibold text-slate-800">{msg.content.text}</p></div>;
                        default: return <p className="whitespace-pre-wrap">{msg.text || JSON.stringify(msg.content)}</p>;
                    }
                };
                
                if (msg.type === 'broadcast') {
                    return <div className="flex justify-center my-4">{renderContent()}</div>;
                }
                
                 return (
                     <div className={`group flex flex-col my-2 ${isUserMessage ? 'items-start' : 'items-end'}`}>
                        <div className={`flex items-end gap-2 ${isUserMessage ? 'flex-row' : 'flex-row-reverse'}`}>
                            <div className="max-w-lg p-3 rounded-2xl" style={{
                                background: isUserMessage ? 'linear-gradient(135deg, #ffffff, #f1f5f9)' : 'linear-gradient(135deg, #2563eb, #3b82f6)',
                                color: isUserMessage ? 'var(--text-color)' : 'white',
                                border: `1px solid ${isUserMessage ? 'var(--border-color)' : 'transparent'}`,
                                borderRadius: isUserMessage ? '1rem 1rem 1rem 0.25rem' : '1rem 1rem 0.25rem 1rem'
                             }}>
                                {msg.type === 'image' ? <img src={msg.content.url} alt="H√¨nh ·∫£nh" className="max-w-xs md:max-w-sm rounded-lg" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x300/f87171/white?text=L·ªói+·∫¢nh'; }} /> : <p className="whitespace-pre-wrap">{msg.text}</p>}
                            </div>
                        </div>
                        {reactions.length > 0 && (
                             <div className={`flex items-center space-x-1 mt-1 ${isUserMessage ? 'ml-2' : 'mr-2'}`}>
                                {reactions.map(([emoji, count]) => ( <span key={emoji} className="text-xs bg-slate-200 rounded-full px-2 py-0.5">{emoji} {count}</span> ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                 <Fragment>
                    <div className="h-screen w-screen flex items-center justify-center p-4">
                        <div className="w-full h-full max-w-7xl ui-frame no-padding flex overflow-hidden">
                            {/* Left Panel */}
                            <div className="w-1/3 border-r border-[var(--border-color)] flex flex-col">
                                <header className="p-4 border-b border-[var(--border-color)] flex-shrink-0 flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-slate-800">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                                    <button onClick={onLogout} className="secondary-btn px-3 py-1.5 text-sm">ƒêƒÉng xu·∫•t</button>
                                </header>
                                <div className="p-4 border-b border-[var(--border-color)]">
                                    <h3 className="font-orbitron font-bold text-slate-700 mb-2">NG∆Ø·ªúI D√ôNG ONLINE ({onlineUsers.length})</h3>
                                    <div className="max-h-32 overflow-y-auto custom-scrollbar space-y-2">
                                        {onlineUsers.map(user => (
                                            <div key={user.uid} className="flex items-center space-x-2 p-1 bg-slate-200/50 rounded-lg">
                                                <img src={user.avatarUrl} className="w-8 h-8 rounded-full" onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/32x32/e2e8f0/64748b?text=${user.username.charAt(0).toUpperCase()}`; }} />
                                                <span className="font-semibold text-sm text-slate-700">{user.username}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setShowBroadcastModal(true)} className="w-full primary-btn mt-3 text-sm py-2" style={{'--primary-color': 'var(--success-color)'}}>G·ª≠i Th√¥ng B√°o Chung</button>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar">
                                    {conversations.map(conv => (
                                        <div key={conv.id} onClick={() => setCurrentChat(conv)} className={`p-4 cursor-pointer border-b border-slate-200 flex justify-between items-center transition-colors duration-200 ${currentChat?.id === conv.id ? 'bg-blue-100' : 'hover:bg-slate-100'}`}>
                                            <div className="flex items-center space-x-3">
                                                <img src={conv.avatarUrl} className="w-10 h-10 rounded-full" onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/40x40/e2e8f0/64748b?text=${conv.username.charAt(0).toUpperCase()}`; }} />
                                                <div>
                                                    <p className="font-semibold text-slate-800">{conv.username}</p>
                                                    <p className="text-xs text-slate-500">ID: {conv.id.slice(0, 8)}...</p>
                                                </div>
                                            </div>
                                            {conv.isRead === false && <div className="w-3 h-3 bg-blue-500 rounded-full shadow-lg shadow-blue-500/50"></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Chat Window */}
                            <div className="w-2/3 flex flex-col bg-slate-50">
                               {currentChat ? (
                                    <Fragment>
                                        <header className="p-4 border-b border-[var(--border-color)] flex-shrink-0 bg-white">
                                            <h2 className="text-xl font-bold text-slate-800">K√™nh: {currentChat.username}</h2>
                                        </header>
                                        <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                                            {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} />)}
                                            <div ref={messagesEndRef} />
                                        </main>
                                        <footer className="p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-white space-y-3">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-bold text-slate-400">H√ÄNH ƒê·ªòNG NHANH:</span>
                                                <button onClick={() => handleSendMessage('text', {text: 'Xin vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.'})} className="secondary-btn text-xs px-2 py-1">ƒê·ª£i l√°t</button>
                                                <button onClick={() => handleSendMessage('text', {text: 'B√†n th·∫Øng!'})} className="secondary-btn text-xs px-2 py-1 border-green-500 text-green-600 hover:bg-green-50">Th·∫Øng</button>
                                                <button onClick={() => handleSendMessage('text', {text: 'B√†n thua!'})} className="secondary-btn text-xs px-2 py-1 border-red-500 text-red-600 hover:bg-red-50">Thua</button>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <input type="file" accept="image/*" ref={imageInputRef} onChange={handleImageUpload} style={{ display: 'none' }} />
                                                <button onClick={() => imageInputRef.current.click()} disabled={uploadingImage} className="secondary-btn p-2.5">
                                                    {uploadingImage ? <svg className="animate-spin h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>}
                                                </button>
                                                <input value={inputMessage} onChange={handleTyping} onKeyPress={e => { if(e.key === 'Enter') handleSendMessage() }} type="text" placeholder="Ph·∫£n h·ªìi..." className="w-full form-input" />
                                                <button onClick={() => handleSendMessage()} className="primary-btn px-6">G·ª≠i</button>
                                            </div>
                                        </footer>
                                    </Fragment>
                               ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-slate-400 space-y-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1"><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                        <p className="text-xl">Ch·ªçn m·ªôt k√™nh li√™n l·∫°c ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                                    </div>
                               )}
                            </div>
                        </div>
                    </div>
                    {/* Broadcast Modal */}
                    <AnimatedPresence isVisible={showBroadcastModal}>
                        <Modal onClose={() => setShowBroadcastModal(false)}>
                            <h3 className="text-2xl font-bold text-center mb-4 text-slate-800">G·ª≠i Th√¥ng B√°o Chung</h3>
                            <p className="text-center text-sm text-slate-500 mb-4">Tin nh·∫Øn n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn t·∫•t c·∫£ {onlineUsers.length} ng∆∞·ªùi d√πng ƒëang tr·ª±c tuy·∫øn.</p>
                            <textarea value={broadcastMessage} onChange={e => setBroadcastMessage(e.target.value)} className="w-full h-32 p-3 form-input" placeholder="N·ªôi dung th√¥ng b√°o..."></textarea>
                            <div className="flex justify-end space-x-4 mt-4">
                                <button onClick={() => setShowBroadcastModal(false)} className="secondary-btn px-4 py-2">H·ªßy</button>
                                <button onClick={handleBroadcast} disabled={!broadcastMessage.trim()} className="primary-btn px-4 py-2" style={{'--primary-color': 'var(--success-color)'}}>G·ª≠i ƒêi</button>
                            </div>
                        </Modal>
                    </AnimatedPresence>
                 </Fragment>
            );
        };

        const System = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            const userStatusRef = ref(rtdb, '/status/' + user.uid);
                            const isOnline = { isOnline: true, lastSeen: rtdbServerTimestamp(), username: userData.username, avatarUrl: userData.avatarUrl };
                            const isOffline = { isOnline: false, lastSeen: rtdbServerTimestamp(), username: userData.username, avatarUrl: userData.avatarUrl };
                            onValue(ref(rtdb, '.info/connected'), (snapshot) => {
                                if (snapshot.val() === false) return;
                                onDisconnect(userStatusRef).set(isOffline).then(() => set(userStatusRef, isOnline));
                            });
                        }
                    }
                    setCurrentUser(user);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => {
                if (auth.currentUser) {
                    const userStatusRef = ref(rtdb, '/status/' + auth.currentUser.uid);
                    updateDoc(userStatusRef, { isOnline: false, lastSeen: rtdbServerTimestamp() });
                }
                sfx.logout();
                signOut(auth);
            };

            if (isLoading) { return <div className="h-screen w-screen"></div>; }
            const isAdmin = currentUser && currentUser.email.split('@')[0] === ADMIN_USERNAME;

            return (
                <Fragment>
                    <AnimatedPresence isVisible={!currentUser}>
                        <LoginScreen />
                    </AnimatedPresence>
                    <AnimatedPresence isVisible={!!currentUser}>
                        <div> 
                            {isAdmin ? <AdminDashboard currentUser={currentUser} onLogout={handleLogout} /> : <UserView currentUser={currentUser} onLogout={handleLogout} />}
                        </div>
                    </AnimatedPresence>
                </Fragment>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<System />);
    </script>
</body>
</html>
