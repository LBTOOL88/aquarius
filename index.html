<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aquarius V</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
      }
    </script>

    <style>
        :root {
            --primary-glow: #00ddff;
            --secondary-glow: #f923a5;
            --warning-glow: #ffc400;
            --danger-glow: #ff3838;
            --bg-color: #000000;
            --border-size: 2px;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-color);
            color: #E0E0E0;
            overflow: hidden;
        }
        
        h1, h2, h3, h4, h5, h6, .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .font-tech-mono {
            font-family: 'Share Tech Mono', monospace;
        }

        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }

        /* --- Ultimate A.I. HUD Frame V5 --- */
        .hud-frame {
            background: rgba(1, 4, 17, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: relative;
            padding: 2rem;
            clip-path: polygon(0 30px, 30px 0, calc(100% - 30px) 0, 100% 30px, 100% calc(100% - 30px), calc(100% - 30px) 100%, 30px 100%, 0 calc(100% - 30px));
            border: 1px solid rgba(0, 221, 255, 0.2);
        }
        .hud-frame.no-padding { padding: 0; }

        .hud-frame::before {
            content: '';
            position: absolute;
            inset: 0;
            z-index: -1;
            background: 
                linear-gradient(var(--primary-glow), var(--primary-glow)) left top,
                linear-gradient(var(--primary-glow), var(--primary-glow)) right top,
                linear-gradient(var(--primary-glow), var(--primary-glow)) left bottom,
                linear-gradient(var(--primary-glow), var(--primary-glow)) right bottom;
            background-repeat: no-repeat;
            background-size: 2px 50px, 50px 2px;
            animation: border-flicker 3s linear infinite;
        }
        .hud-frame::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: -2;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 5px, rgba(0, 221, 255, 0.1) 5px, rgba(0, 221, 255, 0.1) 6px),
                repeating-linear-gradient(90deg, transparent, transparent 5px, rgba(0, 221, 255, 0.1) 5px, rgba(0, 221, 255, 0.1) 6px);
            animation: grid-move 10s linear infinite;
        }
        @keyframes border-flicker { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes grid-move { from { background-position: 0 0; } to { background-position: 100px 100px; } }

        /* --- UI Elements V5 --- */
        .form-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid rgba(0, 221, 255, 0.3);
            color: #FFF;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            padding: 0.5rem 0;
            position: relative;
        }
        .form-input:focus {
            outline: none;
            border-bottom-color: var(--primary-glow);
            box-shadow: 0 5px 15px -5px var(--primary-glow);
        }
        .primary-btn {
            font-family: 'Orbitron', sans-serif;
            background: transparent;
            color: var(--primary-glow);
            font-weight: 700;
            transition: all 0.3s ease;
            border: 2px solid var(--primary-glow);
            padding: 0.75rem 1.5rem;
            text-shadow: 0 0 10px var(--primary-glow);
            box-shadow: 0 0 10px var(--primary-glow) inset, 0 0 10px var(--primary-glow);
            position: relative;
            overflow: hidden;
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        .primary-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: all 0.5s ease;
        }
        .primary-btn:hover:not(:disabled)::after {
            transform: translate(-50%, -50%) scale(100);
            opacity: 0;
        }
        .primary-btn:hover:not(:disabled) {
            background: var(--primary-glow);
            color: var(--bg-color);
            box-shadow: 0 0 25px var(--primary-glow);
        }
        .primary-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(50%); }

        .secondary-btn {
            font-family: 'Orbitron', sans-serif;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #FFF;
            transition: all 0.3s ease;
        }
        .secondary-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: #FFF; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary-glow); box-shadow: 0 0 10px var(--primary-glow); }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 15px 0px var(--glow-color, rgba(255, 196, 0, 0.5)); }
            50% { box-shadow: 0 0 25px 10px var(--glow-color, rgba(255, 196, 0, 0.8)); }
            100% { box-shadow: 0 0 15px 0px var(--glow-color, rgba(255, 196, 0, 0.5)); }
        }
        .pulse-announcement {
            animation: pulse-border 2s infinite;
        }

    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        // Three.js background setup (no changes here)
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg-canvas'),
            alpha: true,
            antialias: true,
        });

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        camera.position.set(0, 20, 45);

        const coreGroup = new THREE.Group();
        scene.add(coreGroup);

        const CYLINDER_RADIUS = 20;
        const CYLINDER_HEIGHT = 100;
        const NUM_PARTICLES = 10000;
        const NUM_RINGS = 10;

        const particlePositions = new Float32Array(NUM_PARTICLES * 3);
        const particleData = [];
        for (let i = 0; i < NUM_PARTICLES; i++) {
            const angle = Math.random() * Math.PI * 2;
            const y = (Math.random() - 0.5) * CYLINDER_HEIGHT;
            particlePositions[i * 3] = Math.cos(angle) * CYLINDER_RADIUS;
            particlePositions[i * 3 + 1] = y;
            particlePositions[i * 3 + 2] = Math.sin(angle) * CYLINDER_RADIUS;
            particleData.push({
                speed: Math.random() * 0.1 + 0.02,
                angle: angle,
            });
        }
        const particleGeometry = new THREE.BufferGeometry();
        particleGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        const particleMaterial = new THREE.PointsMaterial({
            color: 0x00ddff,
            size: 0.1,
            blending: THREE.AdditiveBlending,
            transparent: true,
            depthWrite: false,
        });
        const particles = new THREE.Points(particleGeometry, particleMaterial);
        coreGroup.add(particles);

        const ringGeometry = new THREE.TorusGeometry(CYLINDER_RADIUS, 0.1, 16, 200);
        const ringMaterial = new THREE.MeshBasicMaterial({ color: 0x00ddff, transparent: true, opacity: 0.2 });
        for (let i = 0; i < NUM_RINGS; i++) {
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.x = Math.PI / 2;
            ring.position.y = (i - NUM_RINGS / 2) * (CYLINDER_HEIGHT / NUM_RINGS) + Math.random() * 5 - 2.5;
            coreGroup.add(ring);
        }
        
        const beamGeo = new THREE.CylinderGeometry(0.5, 0.5, CYLINDER_HEIGHT * 2, 32, 1, true);
        const beamMat = new THREE.ShaderMaterial({
            uniforms: { time: { value: 0 } },
            vertexShader: 'varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }',
            fragmentShader: 'uniform float time; varying vec2 vUv; void main() { float alpha = pow(sin(vUv.y * 3.14159 + time * 2.0) * 0.5 + 0.5, 2.0); gl_FragColor = vec4(0.0, 0.8, 1.0, alpha * 0.2); }',
            transparent: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });
        const beam = new THREE.Mesh(beamGeo, beamMat);
        coreGroup.add(beam);

        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        composer.addPass(renderPass);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.1;
        bloomPass.strength = 1.2;
        bloomPass.radius = 0.5;
        composer.addPass(bloomPass);
        const filmPass = new FilmPass(0.15, 0.025, 648, false);
        composer.addPass(filmPass);

        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = event.clientX / window.innerWidth - 0.5;
            mouseY = event.clientY / window.innerHeight - 0.5;
        });

        const clock = new THREE.Clock();
        const animate = () => {
            const elapsedTime = clock.getElapsedTime();
            const positions = particles.geometry.attributes.position.array;
            for(let i=0; i < NUM_PARTICLES; i++) {
                positions[i * 3 + 1] += particleData[i].speed;
                if(positions[i * 3 + 1] > CYLINDER_HEIGHT / 2) {
                    positions[i * 3 + 1] = -CYLINDER_HEIGHT / 2;
                }
            }
            particles.geometry.attributes.position.needsUpdate = true;
            camera.position.x += (mouseX * 20 - camera.position.x) * 0.05;
            camera.position.y += (-mouseY * 20 - (camera.position.y - 20)) * 0.05;
            camera.lookAt(scene.position);
            coreGroup.rotation.y = elapsedTime * 0.05;
            beamMat.uniforms.time.value = elapsedTime;
            composer.render();
            window.requestAnimationFrame(animate);
        };
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, orderBy, query, serverTimestamp, addDoc, updateDoc, writeBatch, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const { useState, useEffect, useRef, Fragment } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
            authDomain: "long-bao-tool-ai.firebaseapp.com",
            projectId: "long-bao-tool-ai",
            storageBucket: "long-bao-tool-ai.appspot.com",
            messagingSenderId: "259613170671",
            appId: "1:259613170671:web:55291d0b0af4e69052b41a",
            measurementId: "G-7V7H3JWX7K",
            databaseURL: "https://long-bao-tool-ai-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        const ADMIN_USERNAME = "admin";
        const DUMMY_DOMAIN = "@long-bao-tool-ai.web.app";

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- GLOBAL CONSTANTS ---
        const BACARAT_TABLES = ["BACARAT C04", "BACARAT C05", "BACARAT C06", "BACARAT C07", "BACARAT C01", "BACARAT C02", "BACARAT C03", "BACARAT C08", "BACARAT C09", "BACARAT C10", "BACARAT 1", "BACARAT 2", "BACARAT 3", "BACARAT 4", "BACARAT 5", "BACARAT 7", "BACARAT 8", "BACARAT 9", "BACARAT 10", "BACARAT C11", "BACARAT C12", "BACARAT C13", "BACARAT C15"];
        const MAX_ENERGY = 100;
        
        // --- SOUND FX ---
        const sfx = {
            boot: () => new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("C3", "8n"),
            typing: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.1, sustain: 0 } }).toDestination(),
            confirm: () => new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease("C5", "8n"),
            logout: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.2 } }).toDestination().triggerAttackRelease("C4", "4n"),
            error: () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0 } }).toDestination().triggerAttackRelease("8n"),
            notification: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("G5", "16n", Tone.now() + 0.1).triggerAttackRelease("C6", "16n", Tone.now() + 0.2),
            glitch: () => new Tone.NoiseSynth({ noise: { type: "brown" }, envelope: { attack: 0.01, decay: 0.05, sustain: 0 } }).toDestination().triggerAttackRelease("16n"),
            blessing: () => new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.2, decay: 0.3, sustain: 0.5, release: 0.5 } }).toDestination().triggerAttackRelease("A4", "2n"),
            warning: () => new Tone.Synth({ oscillator: { type: "fmsquare", modulationIndex: 1.2 }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.2 } }).toDestination().triggerAttackRelease("A3", "4n"),
        };

        // --- HELPER COMPONENTS & HOOKS ---
        const AnimatedPresence = ({ isVisible, children }) => {
            const [shouldRender, setShouldRender] = useState(isVisible);
            useEffect(() => {
                if (isVisible) setShouldRender(true);
                else { const timer = setTimeout(() => setShouldRender(false), 500); return () => clearTimeout(timer); }
            }, [isVisible]);
            if (!shouldRender) return null;
            return React.cloneElement(children, { className: `${children.props.className || ''} ${isVisible ? 'fade-in' : 'fade-out'}` });
        };
        
        const useDecryptingText = (targetText, start, options = {}) => {
            const { speed = 30, onComplete } = options;
            const [text, setText] = useState('');
            const chars = '!<>-_\\/[]{}—=+*^?#________';
            
            useEffect(() => {
                if (!start) return;
                let frameRequest;
                let frame = 0;
                const animate = () => {
                    frame++;
                    const progress = frame / speed;
                    let newText = '';
                    for (let i = 0; i < targetText.length; i++) {
                        if (i < progress * targetText.length) {
                            newText += targetText[i];
                        } else {
                            newText += chars[Math.floor(Math.random() * chars.length)];
                        }
                    }
                    setText(newText);
                    if (progress < 1) {
                         if(frame % 3 === 0) sfx.glitch();
                         frameRequest = requestAnimationFrame(animate);
                    } else {
                        setText(targetText);
                        if (onComplete) onComplete();
                        else sfx.confirm();
                    }
                };
                
                const timeoutId = setTimeout(() => {
                    frameRequest = requestAnimationFrame(animate);
                }, 500);


                return () => {
                    cancelAnimationFrame(frameRequest);
                    clearTimeout(timeoutId);
                }
            }, [targetText, start, speed, onComplete]);
            
            return text;
        };

        const Modal = ({ children, onClose, size = 'md' }) => (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 fade-in" onClick={onClose}>
                <div className={`w-full max-w-${size} hud-frame`} onClick={e => e.stopPropagation()}>{children}</div>
            </div>
        );
        
        //================================================================================
        // COMPONENT: LoginScreen
        //================================================================================
        const LoginScreen = () => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [startDecrypt, setStartDecrypt] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => setStartDecrypt(true), 100);
                return () => clearTimeout(timer);
            }, []);

            const titleText = useDecryptingText("AQUARIUS V", startDecrypt);
            const subtitleText = useDecryptingText("SIÊU TRÍ TUỆ", startDecrypt);
            const userPlaceholder = useDecryptingText("Mã hiệu Pilot", startDecrypt);
            const passPlaceholder = useDecryptingText("Mật khẩu", startDecrypt);
            const connectButton = useDecryptingText("KẾT NỐI", startDecrypt);
            const createButton = useDecryptingText("Chưa có tài khoản? Khởi tạo", startDecrypt);


            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true); setError('');
                await Tone.start();
                const email = username.trim().toLowerCase() + DUMMY_DOMAIN;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    setError("Xác thực thất bại. Vui lòng kiểm tra lại.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleSignup = async () => {
                setIsLoading(true); setError('');
                await Tone.start();
                const processedUsername = username.trim().toLowerCase();
                if (!processedUsername || !password) { sfx.error(); setError("Vui lòng nhập đủ thông tin."); setIsLoading(false); return; }
                if (password.length < 6) { sfx.error(); setError("Mật khẩu phải có ít nhất 6 ký tự."); setIsLoading(false); return; }
                
                const email = processedUsername + DUMMY_DOMAIN;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, "users", userCredential.user.uid);
                    await setDoc(userDocRef, {
                        uid: userCredential.user.uid, username: processedUsername, createdAt: serverTimestamp(),
                        energy: 7, hasSubmittedInfo: false, lastBlessingTimestamp: null, lastLoanRequestTimestamp: null
                    });
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    if (err.code === 'auth/email-already-in-use') setError("Mã hiệu này đã được sử dụng.");
                    else setError("Không thể tạo tài khoản mới.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md hud-frame">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-black text-white font-orbitron">{titleText}</h1>
                            <p className="text-[var(--primary-glow)] tracking-[0.3em] font-bold font-tech-mono">{subtitleText}</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <input value={username} onChange={e => setUsername(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="text" placeholder={userPlaceholder} className="w-full form-input font-tech-mono" />
                            <input value={password} onChange={e => setPassword(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="password" placeholder={passPlaceholder} className="w-full form-input font-tech-mono" />
                            {error && <p className="text-red-400 text-center text-sm font-semibold">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full primary-btn">
                                {isLoading ? 'ĐANG KẾT NỐI...' : connectButton}
                            </button>
                        </form>
                        <div className="text-center mt-6">
                            <button onClick={handleSignup} disabled={isLoading} className="font-semibold text-[var(--primary-glow)] hover:text-white text-sm font-tech-mono">
                               {createButton}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        //================================================================================
        // COMPONENT: UserView
        //================================================================================
        const UserView = ({ currentUser, onLogout }) => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [userData, setUserData] = useState(null);
            const [showBlessingModal, setShowBlessingModal] = useState(false);
            const [showLoanModal, setShowLoanModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [plea, setPlea] = useState('');
            const [loanFormData, setLoanFormData] = useState({ accountName: '', amount: '' });
            const [infoFormData, setInfoFormData] = useState({ f168Account: '', capital: '', target: '' });
            const [isAdminTyping, setIsAdminTyping] = useState(false);
            const [blessingCooldown, setBlessingCooldown] = useState("");
            const [loanCooldown, setLoanCooldown] = useState("");
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isAdminTyping]);
            
            useEffect(() => {
                if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }, []);

            const useCooldownTimer = (lastTimestamp, setCooldownString) => {
                 useEffect(() => {
                    if (!userData || !lastTimestamp) {
                        setCooldownString("");
                        return;
                    }

                    const interval = setInterval(() => {
                        const now = Date.now();
                        const lastTime = lastTimestamp.toMillis();
                        const twentyFourHours = 24 * 60 * 60 * 1000;
                        const timePassed = now - lastTime;

                        if (timePassed < twentyFourHours) {
                            const timeLeft = twentyFourHours - timePassed;
                            const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                            const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                            const seconds = Math.floor((timeLeft / 1000) % 60);
                            setCooldownString(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                        } else {
                            setCooldownString("");
                            clearInterval(interval);
                        }
                    }, 1000);

                    return () => clearInterval(interval);
                }, [userData, lastTimestamp]);
            }

            useCooldownTimer(userData?.lastBlessingTimestamp, setBlessingCooldown);
            useCooldownTimer(userData?.lastLoanRequestTimestamp, setLoanCooldown);

            useEffect(() => {
                if (!currentUser) return;

                const userDocRef = doc(db, 'users', currentUser.uid);
                const unsubUser = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setUserData(data);
                        if(data.hasSubmittedInfo !== true) setShowInfoModal(true);
                    }
                });

                const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                const q = query(messagesColRef, orderBy('timestamp'));
                const unsubMessages = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const newMessage = change.doc.data();
                            if (newMessage.senderId !== currentUser.uid) {
                                sfx.notification();
                                if (document.hidden && Notification.permission === "granted") {
                                    new Notification("Tin nhắn mới từ Aquarius V", {
                                        body: newMessage.text || "Bạn có một tin nhắn đặc biệt.",
                                        icon: "https://i.imgur.com/9J03b7I.png"
                                    });
                                }
                            }
                        }
                    });
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const typingRef = ref(rtdb, `typing_status/${currentUser.uid}`);
                const unsubTyping = onValue(typingRef, (snapshot) => {
                    setIsAdminTyping(snapshot.val()?.isTyping || false);
                });

                return () => { unsubUser(); unsubMessages(); unsubTyping(); };
            }, [currentUser]);

            const handleSendMessage = async () => {
                const content = inputMessage.trim();
                if (content === '') return;
                sfx.confirm();
                const username = currentUser.email.split('@')[0];
                const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                await addDoc(messagesColRef, { type: 'text', text: content, senderId: currentUser.uid, timestamp: serverTimestamp() });
                await setDoc(doc(db, 'user_chats', currentUser.uid), { lastUpdate: serverTimestamp(), username: username, userId: currentUser.uid, isRead: false }, { merge: true });
                setInputMessage('');
            };
            
            const handleBlessingRequest = async () => {
                if(plea.trim() === '' || blessingCooldown) return;
                sfx.blessing();
                setShowBlessingModal(false);
                const blessing = { table: BACARAT_TABLES[Math.floor(Math.random() * BACARAT_TABLES.length)], side: Math.random() < 0.5 ? 'NHÀ CON' : 'NHÀ CÁI', hand: Math.floor(Math.random() * 16) + 15 };
                await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'blessing', content: blessing, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp() });
                await updateDoc(doc(db, 'users', currentUser.uid), { lastBlessingTimestamp: serverTimestamp() });
                setPlea('');
            };

            const handleLoanRequest = async () => {
                if (!loanFormData.accountName.trim() || !loanFormData.amount.trim() || loanCooldown) return;
                sfx.confirm();
                setShowLoanModal(false);
                await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), {
                    type: 'loan_request_details',
                    content: {
                        ...loanFormData,
                        requestText: 'NGƯỜI DÙNG ĐÃ GỬI YÊU CẦU ỨNG TIỀN ĐẾN AQUARIUS, VUI LÒNG ĐỢI'
                    },
                    senderId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, 'users', currentUser.uid), { lastLoanRequestTimestamp: serverTimestamp() });
                await setDoc(doc(db, 'user_chats', currentUser.uid), { lastUpdate: serverTimestamp(), isRead: false }, { merge: true });
                setLoanFormData({ accountName: '', amount: '' });
            };

            const handleInfoSubmit = async () => {
                const { f168Account, capital, target } = infoFormData;
                if (!f168Account || !capital || !target) return;
                sfx.confirm();
                await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'info_submission', content: { f168Account, capital, target }, senderId: currentUser.uid, timestamp: serverTimestamp() });
                await updateDoc(doc(db, 'users', currentUser.uid), { hasSubmittedInfo: true });
                setShowInfoModal(false);
            };

            if (!userData) return null;
            
            const MessageBubble = ({ children, isUser, className }) => {
                const style = {
                    clipPath: isUser 
                        ? 'polygon(0% 0%, 100% 0%, 100% 100%, 15% 100%, 0% 85%)' 
                        : 'polygon(0% 0%, 100% 0%, 100% 85%, 85% 100%, 0% 100%)',
                    background: isUser
                        ? 'linear-gradient(135deg, rgba(0, 130, 255, 0.2), rgba(0, 196, 255, 0.1))'
                        : 'linear-gradient(135deg, rgba(60, 60, 80, 0.3), rgba(40, 40, 60, 0.2))',
                    border: '1px solid',
                    borderColor: isUser ? 'rgba(0, 221, 255, 0.3)' : 'rgba(100, 100, 120, 0.3)'
                };
                return <div className={`p-4 ${className}`} style={style}>{children}</div>
            }

            const TypingIndicator = () => {
                const text = useDecryptingText("AQUARIUS IS TYPING...", true, { speed: 10, onComplete: () => {} });
                return (
                    <div className="flex mb-4 justify-start">
                        <div className="max-w-lg">
                            <MessageBubble isUser={false}>
                                <p className="text-white text-lg font-tech-mono">{text}</p>
                            </MessageBubble>
                        </div>
                    </div>
                );
            };

            const BlessingHistoryModal = ({ messages, onClose }) => {
                const blessingMessages = messages.filter(m => m.type === 'blessing').reverse();
                return (
                    <Modal onClose={onClose} size="lg">
                        <h3 className="text-2xl font-bold text-center mb-4 text-white">Lịch sử Ban Phước</h3>
                        <div className="max-h-[60vh] overflow-y-auto custom-scrollbar pr-4">
                            {blessingMessages.length > 0 ? blessingMessages.map(msg => (
                                <div key={msg.id} className="p-4 border-2 border-[var(--secondary-glow)] rounded-lg text-center space-y-1 shadow-[0_0_20px_var(--secondary-glow)] mb-4">
                                    <p className="text-sm text-gray-400">{msg.timestamp?.toDate().toLocaleString('vi-VN')}</p>
                                    <p><span className="font-semibold text-[var(--primary-glow)]">Bàn:</span> {msg.content.table}</p>
                                    <p><span className="font-semibold text-[var(--primary-glow)]">Kết quả:</span> {msg.content.side}</p>
                                    <p><span className="font-semibold text-[var(--primary-glow)]">Tay thứ:</span> {msg.content.hand}</p>
                                </div>
                            )) : <p className="text-center text-gray-400">Chưa có lịch sử.</p>}
                        </div>
                        <div className="flex justify-end mt-6">
                            <button onClick={onClose} className="primary-btn">Đóng</button>
                        </div>
                    </Modal>
                )
            };
            
            const EnergyBar = ({ current, max }) => {
                const percentage = Math.min(100, (current / max) * 100);
                return (
                     <div className="w-full">
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-sm font-bold text-[var(--primary-glow)]">NĂNG LƯỢNG</span>
                            <span className="text-sm font-bold text-white">{current} / {max}</span>
                        </div>
                        <div className="w-full bg-black/50 border border-white/20 h-4" style={{clipPath: 'polygon(0 0, 100% 0, 100% 100%, 0 100%)'}}>
                            <div 
                                className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full transition-all duration-500"
                                style={{ width: `${percentage}%`, boxShadow: `0 0 10px var(--primary-glow)` }}
                            ></div>
                        </div>
                    </div>
                );
            };

            const MessageRenderer = ({ msg }) => {
                const isUser = msg.senderId === currentUser.uid;
                
                const renderContent = () => {
                    switch(msg.type) {
                        case 'blessing': return (<div className="p-4 border-2 border-[var(--secondary-glow)] rounded-lg text-center space-y-1 shadow-[0_0_20px_var(--secondary-glow)]"><p className="text-lg font-bold text-white uppercase tracking-widest">Lời Ban Phước</p><p><span className="font-semibold text-[var(--primary-glow)]">Bàn:</span> {msg.content.table}</p><p><span className="font-semibold text-[var(--primary-glow)]">Kết quả:</span> {msg.content.side}</p><p><span className="font-semibold text-[var(--primary-glow)]">Tay thứ:</span> {msg.content.hand}</p></div>);
                        case 'info_submission': return (<div className="space-y-1 text-sm"><p className="font-bold text-center text-[var(--primary-glow)]">BÁO CÁO KHỞI TẠO</p><p>Tài khoản F168: {msg.content.f168Account}</p><p>Số vốn: {msg.content.capital}</p><p>Mục tiêu: {msg.content.target}</p></div>);
                        case 'loan_request_details': return <p className="text-yellow-400 italic text-center">-- {msg.content.requestText} (Tài khoản: {msg.content.accountName}, Số tiền: {msg.content.amount}) --</p>;
                        case 'baccarat_result': return <div className={`flex items-center justify-center w-24 h-24 rounded-full border-4`} style={{backgroundColor: msg.content.color, borderColor: msg.content.color, color: 'white', textShadow: '0 0 5px black'}}><span className="text-6xl font-black">{msg.content.result}</span></div>;
                        case 'table_announcement': return <div className="p-4 border-2 border-[var(--warning-glow)] bg-yellow-900/30 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--warning-glow)'}}><h4 className="text-xl font-bold text-[var(--warning-glow)] uppercase tracking-widest">THÔNG BÁO BÀN</h4><p className="text-2xl font-bold text-white">{msg.content.text}</p></div>;
                        case 'warning': return <div className="p-4 border-2 border-[var(--danger-glow)] bg-red-900/40 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--danger-glow)'}}><h4 className="text-xl font-bold text-[var(--danger-glow)] uppercase tracking-widest">CẢNH BÁO</h4><p className="text-xl font-semibold text-white">{msg.content.text}</p></div>;
                        case 'wait_message': return <p className="text-cyan-300 italic text-center">-- {msg.content.text} --</p>;
                        default: return <p className="text-white text-lg">{msg.text}</p>;
                    }
                };
                
                const isSpecialMessage = ['baccarat_result', 'table_announcement', 'wait_message', 'loan_request_details', 'warning'].includes(msg.type);

                if (isSpecialMessage) {
                    return <div className="flex justify-center my-4">{renderContent()}</div>;
                }

                return (
                    <div className={`flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}`}>
                        <div className="max-w-lg">
                            <MessageBubble isUser={isUser}>{renderContent()}</MessageBubble>
                        </div>
                    </div>
                );
            };


            return (
                <Fragment>
                    <div className="h-screen w-screen flex items-center justify-center p-4">
                        <div className="w-full h-full max-w-4xl hud-frame flex flex-col">
                            <header className="flex justify-between items-center p-4 flex-shrink-0 space-x-4">
                                <div className="flex-1">
                                    <h2 className="text-xl font-bold text-white">PILOT: {currentUser.email.split('@')[0].toUpperCase()}</h2>
                                    <EnergyBar current={userData.energy} max={MAX_ENERGY} />
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => setShowLoanModal(true)} disabled={!!loanCooldown} className="secondary-btn px-4 py-2 text-sm disabled:opacity-50 disabled:filter-none" style={{'--secondary-glow': 'var(--warning-glow)', color: 'var(--warning-glow)', borderColor: 'var(--warning-glow)'}}>{loanCooldown ? <span className="font-tech-mono text-xs">{loanCooldown}</span> : 'Ứng tiền'}</button>
                                    <button onClick={() => setShowHistoryModal(true)} className="secondary-btn px-4 py-2 text-sm">Lịch sử</button>
                                    <button onClick={onLogout} className="secondary-btn px-4 py-2">Ngắt kết nối</button>
                                </div>
                            </header>
                            
                            <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                               {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} />)}
                               {isAdminTyping && <TypingIndicator />}
                               <div ref={messagesEndRef} />
                            </main>

                            <footer className="p-4 flex-shrink-0">
                                <div className="flex items-center space-x-4">
                                    <button onClick={() => setShowBlessingModal(true)} disabled={!!blessingCooldown} className="primary-btn px-4 disabled:filter-none disabled:opacity-50" style={{'--primary-glow': 'var(--secondary-glow)'}}>
                                        {blessingCooldown ? <span className="font-tech-mono text-xs">{blessingCooldown}</span> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>}
                                    </button>
                                    <input value={inputMessage} onChange={e => setInputMessage(e.target.value)} onKeyPress={e => { sfx.typing.triggerAttack("C2"); if(e.key === 'Enter') handleSendMessage() }} type="text" placeholder="Gửi tín hiệu..." className="w-full form-input" />
                                    <button onClick={handleSendMessage} className="primary-btn px-6">Gửi</button>
                                </div>
                            </footer>
                        </div>
                    </div>
                    
                    <AnimatedPresence isVisible={showBlessingModal}>
                        <Modal onClose={() => setShowBlessingModal(false)}>
                            <h3 className="text-2xl font-bold text-center mb-4 text-white">Truyền Tải Thỉnh Cầu</h3>
                            <textarea value={plea} onChange={e => setPlea(e.target.value)} className="w-full h-24 p-3 form-input bg-[rgba(0,0,0,0.3)]" placeholder="Viết lời thỉnh cầu của bạn..."></textarea>
                            <div className="flex justify-end space-x-4 mt-4">
                                <button onClick={() => setShowBlessingModal(false)} className="secondary-btn px-4 py-2">Hủy</button>
                                <button onClick={handleBlessingRequest} disabled={!plea.trim() || !!blessingCooldown} className="primary-btn px-4 py-2">Gửi</button>
                            </div>
                        </Modal>
                    </AnimatedPresence>
                     <AnimatedPresence isVisible={showInfoModal}>
                         <Modal onClose={() => {}}>
                            <h3 className="text-2xl font-bold text-center mb-4 text-white">Yêu Cầu Khai Báo</h3>
                            <div className="space-y-4">
                                <input value={infoFormData.f168Account} onChange={e => setInfoFormData({...infoFormData, f168Account: e.target.value})} type="text" placeholder="Tên TK F168" className="w-full form-input" />
                                <input value={infoFormData.capital} onChange={e => setInfoFormData({...infoFormData, capital: e.target.value})} type="text" placeholder="Số vốn" className="w-full form-input" />
                                <input value={infoFormData.target} onChange={e => setInfoFormData({...infoFormData, target: e.target.value})} type="text" placeholder="Muốn lên bao nhiêu" className="w-full form-input" />
                            </div>
                            <div className="flex justify-end mt-6">
                                <button onClick={handleInfoSubmit} className="primary-btn w-full">Gửi Báo Cáo</button>
                            </div>
                        </Modal>
                    </AnimatedPresence>
                    <AnimatedPresence isVisible={showHistoryModal}>
                        <BlessingHistoryModal messages={messages} onClose={() => setShowHistoryModal(false)} />
                    </AnimatedPresence>
                    <AnimatedPresence isVisible={showLoanModal}>
                        <Modal onClose={() => setShowLoanModal(false)}>
                            <h3 className="text-2xl font-bold text-center mb-4 text-[var(--warning-glow)]">Yêu cầu ứng năng lượng</h3>
                            <div className="space-y-4">
                                <input value={loanFormData.accountName} onChange={e => setLoanFormData({...loanFormData, accountName: e.target.value})} type="text" placeholder="Tên tài khoản" className="w-full form-input" />
                                <input value={loanFormData.amount} onChange={e => setLoanFormData({...loanFormData, amount: e.target.value})} type="text" placeholder="Số tiền muốn ứng" className="w-full form-input" />
                            </div>
                             <div className="flex justify-center space-x-4 mt-6">
                                <button onClick={() => setShowLoanModal(false)} className="secondary-btn px-6 py-2">Hủy</button>
                                <button onClick={handleLoanRequest} disabled={!loanFormData.accountName.trim() || !loanFormData.amount.trim() || !!loanCooldown} className="primary-btn px-6 py-2" style={{'--primary-glow': 'var(--warning-glow)'}}>Xác nhận</button>
                            </div>
                        </Modal>
                    </AnimatedPresence>
                </Fragment>
            );
        };

        //================================================================================
        // COMPONENT: AdminDashboard
        //================================================================================
        const AdminDashboard = ({ currentUser, onLogout }) => {
            const [conversations, setConversations] = useState([]);
            const [currentChat, setCurrentChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [tableAnnounceInput, setTableAnnounceInput] = useState('');
            const [warningInput, setWarningInput] = useState('');
            const [editingMessage, setEditingMessage] = useState({ id: null, text: '' });
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);

            useEffect(() => {
                const q = query(collection(db, 'user_chats'), orderBy('lastUpdate', 'desc'));
                const unsub = onSnapshot(q, snapshot => {
                    setConversations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!currentChat) return;
                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                    const typingRef = ref(rtdb, `typing_status/${currentChat.id}`);
                    set(typingRef, { isTyping: false });
                }

                const messagesColRef = collection(db, 'user_chats', currentChat.id, 'messages');
                const q = query(messagesColRef, orderBy('timestamp'));
                const unsub = onSnapshot(q, snapshot => {
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsub();
            }, [currentChat]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const handleTyping = (e) => {
                if (!currentChat) return;
                setInputMessage(e.target.value);
                
                const typingRef = ref(rtdb, `typing_status/${currentChat.id}`);

                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                } else {
                    set(typingRef, { isTyping: true });
                }

                typingTimeoutRef.current = setTimeout(() => {
                    set(typingRef, { isTyping: false });
                    typingTimeoutRef.current = null;
                }, 2000);
            };

            const handleSendMessage = async (type = 'text', content = null) => {
                if (!currentChat) return;
                const text = content ? content.text : inputMessage.trim();
                if (text === '' && type === 'text') return;
                
                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                    const typingRef = ref(rtdb, `typing_status/${currentChat.id}`);
                    set(typingRef, { isTyping: false });
                    typingTimeoutRef.current = null;
                }

                sfx.confirm();
                const messagesColRef = collection(db, 'user_chats', currentChat.id, 'messages');
                await addDoc(messagesColRef, {
                    type: type,
                    text: type === 'text' ? text : null,
                    content: type !== 'text' ? content : null,
                    senderId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, 'user_chats', currentChat.id), { lastUpdate: serverTimestamp(), isRead: true });
                if (type === 'text') setInputMessage('');
            };

            const handleSendBaccaratResult = (resultType) => {
                let content;
                switch(resultType) {
                    case 'P': content = { result: 'P', color: '#3498db' }; break;
                    case 'B': content = { result: 'B', color: '#e74c3c' }; break;
                    case 'H': content = { result: 'H', color: '#2ecc71' }; break;
                    default: return;
                }
                handleSendMessage('baccarat_result', content);
            };

            const handleSendTableMessage = () => {
                if(tableAnnounceInput.trim() === '') return;
                handleSendMessage('table_announcement', { text: tableAnnounceInput.trim() });
                setTableAnnounceInput('');
            };
            
             const handleSendWarningMessage = () => {
                if(warningInput.trim() === '') return;
                sfx.warning();
                handleSendMessage('warning', { text: warningInput.trim() });
                setWarningInput('');
            };
            
            const handleSendWaitMessage = () => {
                handleSendMessage('wait_message', { text: 'XIN VUI LÒNG ĐỢI' });
            };

            const handleDeleteUserMessage = async (msgId) => {
                if (!currentChat || !msgId) return;
                if (window.confirm("Bạn có chắc muốn xóa tin nhắn này của người dùng?")) {
                    sfx.error();
                    const msgRef = doc(db, 'user_chats', currentChat.id, 'messages', msgId);
                    await deleteDoc(msgRef);
                }
            };
            
            const handleStartEdit = (msg) => {
                setEditingMessage({ id: msg.id, text: msg.text });
            };

            const handleSaveEdit = async () => {
                if (!currentChat || !editingMessage.id) return;
                const msgRef = doc(db, 'user_chats', currentChat.id, 'messages', editingMessage.id);
                await updateDoc(msgRef, { text: editingMessage.text });
                setEditingMessage({ id: null, text: '' });
                sfx.confirm();
            };

            const MessageRenderer = ({ msg }) => {
                const isUserMessage = msg.senderId !== currentUser.uid;
                const isEditing = editingMessage.id === msg.id;

                if (isEditing) {
                    return (
                        <div className="my-2 p-2 bg-white/10 rounded">
                            <textarea 
                                value={editingMessage.text} 
                                onChange={(e) => setEditingMessage({...editingMessage, text: e.target.value})}
                                className="w-full form-input bg-black/30 p-2"
                            />
                            <div className="flex justify-end space-x-2 mt-2">
                                <button onClick={() => setEditingMessage({id: null, text: ''})} className="secondary-btn text-xs px-2 py-1">Hủy</button>
                                <button onClick={handleSaveEdit} className="primary-btn text-xs px-2 py-1">Lưu</button>
                            </div>
                        </div>
                    );
                }
                
                const renderContent = () => {
                    switch(msg.type) {
                        case 'loan_request_details': return <p className="text-yellow-400 italic text-center">-- {msg.content.requestText} (Tài khoản: {msg.content.accountName}, Số tiền: {msg.content.amount}) --</p>;
                        case 'baccarat_result': return <div className={`flex items-center justify-center w-24 h-24 rounded-full border-4`} style={{backgroundColor: msg.content.color, borderColor: msg.content.color, color: 'white', textShadow: '0 0 5px black'}}><span className="text-6xl font-black">{msg.content.result}</span></div>;
                        case 'table_announcement': return <div className="p-4 border-2 border-[var(--warning-glow)] bg-yellow-900/30 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--warning-glow)'}}><h4 className="text-xl font-bold text-[var(--warning-glow)] uppercase tracking-widest">THÔNG BÁO BÀN</h4><p className="text-2xl font-bold text-white">{msg.content.text}</p></div>;
                        case 'warning': return <div className="p-4 border-2 border-[var(--danger-glow)] bg-red-900/40 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'var(--danger-glow)'}}><h4 className="text-xl font-bold text-[var(--danger-glow)] uppercase tracking-widest">CẢNH BÁO</h4><p className="text-xl font-semibold text-white">{msg.content.text}</p></div>;
                        case 'wait_message': return <p className="text-cyan-300 italic text-center">-- {msg.content.text} --</p>;
                        default: return <p className="text-white text-lg">{msg.text || JSON.stringify(msg.content)}</p>;
                    }
                };
                
                const isSpecialMessage = ['baccarat_result', 'table_announcement', 'wait_message', 'loan_request_details', 'warning'].includes(msg.type);

                if (isSpecialMessage) {
                    return <div className="flex justify-center my-4">{renderContent()}</div>;
                }

                return (
                     <div className={`group flex items-end gap-2 my-2 ${!isUserMessage ? 'justify-end' : 'justify-start'}`}>
                        {isUserMessage && (
                            <div className="hidden group-hover:flex items-center gap-2">
                                <button onClick={() => handleStartEdit(msg)} className="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg></button>
                                <button onClick={() => handleDeleteUserMessage(msg.id)} className="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            </div>
                        )}
                        <div className="max-w-lg">
                             <div className="p-4" style={{
                                clipPath: !isUserMessage ? 'polygon(0% 0%, 100% 0%, 100% 100%, 15% 100%, 0% 85%)' : 'polygon(0% 0%, 100% 0%, 100% 85%, 85% 100%, 0% 100%)',
                                background: !isUserMessage ? 'linear-gradient(135deg, rgba(0, 130, 255, 0.2), rgba(0, 196, 255, 0.1))' : 'linear-gradient(135deg, rgba(60, 60, 80, 0.3), rgba(40, 40, 60, 0.2))',
                                border: '1px solid',
                                borderColor: !isUserMessage ? 'rgba(0, 221, 255, 0.3)' : 'rgba(100, 100, 120, 0.3)'
                             }}>
                                {renderContent()}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                 <div className="h-screen w-screen flex items-center justify-center p-4">
                    <div className="w-full h-full max-w-7xl hud-frame no-padding flex">
                        <div className="w-1/3 border-r border-[var(--primary-glow)]/20 flex flex-col">
                            <header className="p-4 border-b border-[var(--primary-glow)]/20 flex-shrink-0 flex justify-between items-center">
                                <h2 className="text-xl font-bold text-white">Bảng điều khiển</h2>
                                <button onClick={onLogout} className="secondary-btn px-3 py-1.5 text-sm">Đăng xuất</button>
                            </header>
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                {conversations.map(conv => (
                                    <div 
                                        key={conv.id} 
                                        onClick={() => setCurrentChat(conv)}
                                        className={`p-4 cursor-pointer border-b border-white/10 flex justify-between items-center transition-colors duration-200 ${currentChat?.id === conv.id ? 'bg-[var(--primary-glow)]/20' : 'hover:bg-white/10'}`}
                                    >
                                        <div>
                                            <p className="font-semibold text-white text-lg">{conv.username}</p>
                                            <p className="text-xs text-gray-400">ID: {conv.id.slice(0, 8)}...</p>
                                        </div>
                                        <div className="flex items-center space-x-3">
                                            {conv.isRead === false && <div className="w-3 h-3 bg-[var(--primary-glow)] rounded-full shadow-[0_0_10px_var(--primary-glow)]"></div>}
                                            <button onClick={(e) => { e.stopPropagation(); handleDeleteHistory(conv.id); }} className="text-gray-400 hover:text-red-400">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 0 0-2.09 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="w-2/3 flex flex-col">
                           {currentChat ? (
                                <Fragment>
                                    <header className="p-4 border-b border-[var(--primary-glow)]/20 flex-shrink-0">
                                        <h2 className="text-xl font-bold text-white">Kênh: {currentChat.username}</h2>
                                    </header>
                                    <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">
                                        {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} />)}
                                        <div ref={messagesEndRef} />
                                    </main>
                                    <footer className="p-4 border-t border-[var(--primary-glow)]/20 flex-shrink-0 space-y-3 bg-[rgba(1,4,17,0.8)]">
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex items-center space-x-2">
                                                <input value={tableAnnounceInput} onChange={e => setTableAnnounceInput(e.target.value)} type="text" placeholder="Gửi bàn..." className="w-full form-input text-sm !p-2" />
                                                <button onClick={handleSendTableMessage} className="secondary-btn px-4 py-2 text-sm whitespace-nowrap">Gửi Bàn</button>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <input value={warningInput} onChange={e => setWarningInput(e.target.value)} type="text" placeholder="Nội dung cảnh báo..." className="w-full form-input text-sm !p-2 border-[var(--danger-glow)]" />
                                                <button onClick={handleSendWarningMessage} className="secondary-btn px-4 py-2 text-sm whitespace-nowrap border-[var(--danger-glow)] text-[var(--danger-glow)]">Cảnh Báo</button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-4 gap-2">
                                            <button onClick={() => handleSendBaccaratResult('P')} className="secondary-btn p-2 text-sm border-blue-400 text-blue-300">Nhà Con (P)</button>
                                            <button onClick={() => handleSendBaccaratResult('B')} className="secondary-btn p-2 text-sm border-red-400 text-red-300">Nhà Cái (B)</button>
                                            <button onClick={() => handleSendBaccaratResult('H')} className="secondary-btn p-2 text-sm border-green-400 text-green-300">Hòa (H)</button>
                                            <button onClick={handleSendWaitMessage} className="secondary-btn p-2 text-sm">Đợi</button>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <input value={inputMessage} onChange={handleTyping} onKeyPress={e => { if(e.key === 'Enter') handleSendMessage() }} type="text" placeholder="Phản hồi..." className="w-full form-input" />
                                            <button onClick={() => handleSendMessage()} className="primary-btn px-6">Gửi</button>
                                        </div>
                                    </footer>
                                </Fragment>
                           ) : (
                                <div className="flex-1 flex flex-col items-center justify-center text-gray-400 space-y-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-[var(--primary-glow)]/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1"><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                    <p className="text-xl">Chọn một kênh liên lạc để bắt đầu</p>
                                </div>
                           )}
                        </div>
                    </div>
                </div>
            );
        };

        //================================================================================
        // TOP-LEVEL COMPONENT: System
        //================================================================================
        const System = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setCurrentUser(user);
                    setIsLoading(false);
                    if (user) {
                        const userStatusRef = ref(rtdb, '/status/' + user.uid);
                        const isOnline = { isOnline: true, lastSeen: rtdbServerTimestamp() };
                        const isOffline = { isOnline: false, lastSeen: rtdbServerTimestamp() };
                        onValue(ref(rtdb, '.info/connected'), (snapshot) => {
                            if (snapshot.val() === false) return;
                            onDisconnect(userStatusRef).set(isOffline).then(() => set(userStatusRef, isOnline));
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => {
                sfx.logout();
                if (auth.currentUser) {
                    const userStatusRef = ref(rtdb, '/status/' + auth.currentUser.uid);
                    set(userStatusRef, { isOnline: false, lastSeen: rtdbServerTimestamp() });
                }
                signOut(auth);
            };

            if (isLoading) {
                return null; // Show nothing while checking auth state
            }

            const isAdmin = currentUser && currentUser.email.split('@')[0] === ADMIN_USERNAME;

            return (
                <Fragment>
                    <AnimatedPresence isVisible={!currentUser}>
                        <LoginScreen />
                    </AnimatedPresence>
                    <AnimatedPresence isVisible={!!currentUser}>
                        <div> 
                            {isAdmin ? 
                                <AdminDashboard currentUser={currentUser} onLogout={handleLogout} /> :
                                <UserView currentUser={currentUser} onLogout={handleLogout} />
                            }
                        </div>
                    </AnimatedPresence>
                </Fragment>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<System />);
    </script>
</body>
</html>
