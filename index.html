<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aquarius V - SIÊU TRÍ TUỆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
      }
    </script>

    <style>
        :root {
        --primary-color: #22d3ee; /* Cyan 400 */
        --secondary-color: #06b6d4; /* Cyan 500 */
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --success-color: #10b981;
        --bg-color: #0e0f11;      /* Charcoal */
        --panel-color: #1a1c20;   /* Dark panel */
        --text-color: #e6e7eb;    /* Light text */
        --muted-text: #a8b3c7;
        --border-color: rgba(34, 211, 238, 0.25); /* cyan glow */
    }

        html, body, #root {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        h1, h2, h3, h4, h5, h6, .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .font-tech-mono {
            font-family: 'Share Tech Mono', monospace;
        }

        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            opacity: 0.5;
        }

        .ui-frame {
        background: rgba(26, 28, 32, 0.9);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        box-shadow: 0 20px 40px -20px rgba(2, 132, 199, 0.25);
        padding: 1rem;
    }
        @media (min-width: 640px) {
            .ui-frame {
        background: rgba(26, 28, 32, 0.9);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        box-shadow: 0 20px 40px -20px rgba(2, 132, 199, 0.25);
        padding: 1rem;
    }
        }
        .ui-frame.no-padding { padding: 0; }

        .form-input {
            background: rgba(226, 232, 240, 0.7);
            border: 2px solid transparent;
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .primary-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .5rem;
        border-radius: .875rem;
        padding: .6rem 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .06em;
        background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
        color: #001014;
        border: 1px solid rgba(34, 211, 238, 0.6);
        box-shadow: 0 8px 24px -8px rgba(34,211,238,.45);
        transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    .primary-btn:hover { box-shadow: 0 12px 30px -10px rgba(34,211,238,.55); filter: brightness(1.05); }
    .primary-btn:active { transform: translateY(1px) scale(.99); }
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px var(--primary-color);
        }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .secondary-btn {
            font-family: 'Orbitron', sans-serif;
            background-color: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            border-radius: 0.75rem;
        }
        .secondary-btn:hover:not(:disabled) { background-color: rgba(0,0,0,0.05); border-color: var(--text-color); }
        .secondary-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) forwards; }
        
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }

        .pulse-announcement {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px var(--glow-color, rgba(245, 158, 11, 0.5)); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0px rgba(245, 158, 11, 0); }
        }
        
        @keyframes blink-warning {
            50% {
                background-color: var(--warning-color);
                border-color: var(--warning-color);
            }
        }
        .flashing-warning {
            animation: blink-warning 1.5s step-end infinite;
        }

        @keyframes blink-danger-icon {
            50% {
                background-color: var(--danger-color);
                color: white;
            }
        }
        .flashing-danger-icon {
            animation: blink-danger-icon 1s step-end infinite;
        }

        /* --- START: CSS cho công tắc --- */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--success-color);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--success-color);
        }
        /* --- END: CSS cho công tắc --- */
    
        /* Signal composer */
        .signal-composer { padding: 0.75rem; background: rgba(26, 28, 32, 0.9); border: 1px solid var(--border-color); border-radius: 1rem; }
        .signal-input { min-height: 96px; padding: 0.85rem 1rem; font-size: 1.125rem; border-radius: 0.875rem; resize: vertical; }

    
/* === Highlighted Pilot name === */
.pilot-name {
  background: linear-gradient(90deg,#22d3ee,#60a5fa,#a78bfa,#f472b6,#f59e0b,#34d399,#22d3ee);
  background-size: 240% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: pilotShift 6s linear infinite;
  text-shadow: 0 0 10px rgba(34,211,238,.35);
  letter-spacing: .04em;
}
.pilot-name::after {
  content: "";
  display: block;
  height: 2px;
  margin-top: 4px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(34,211,238,.9), rgba(167,139,250,.9), rgba(244,114,182,.9));
  box-shadow: 0 0 16px rgba(34,211,238,.5);
}
@keyframes pilotShift { 0%{background-position:0% 50%} 100%{background-position:240% 50%} }

/* === Multicolor animated Logo === */
.logo-rainbow {
  background: linear-gradient(90deg,#22d3ee,#60a5fa,#a78bfa,#f472b6,#f59e0b,#34d399,#22d3ee);
  background-size: 320% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: logoShift 8s linear infinite;
  filter: drop-shadow(0 2px 20px rgba(34,211,238,.25));
}
@keyframes logoShift { 0%{background-position:0% 50%} 100%{background-position:320% 50%} }

    
/* === Global font: Orbitron === */
body, button, input, textarea, select, h1, h2, h3, h4, h5, h6 {
    font-family: 'Orbitron', sans-serif !important;
    font-weight: 500;
}

    
/* === Force input & textarea typing text color to black === */
input, textarea {
    color: black !important;
}
input::placeholder, textarea::placeholder {
    color: rgba(0,0,0,0.4) !important;
}

    </style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">

<!-- Admin Simple Theme -->
<style id="admin-simple-theme">
/* Root palette */
.admin-theme {
  --primary-color: #2563eb;      /* blue-600 */
  --primary-color-2: #1d4ed8;    /* blue-700 */
  --success-color: #16a34a;      /* green-600 */
  --warning-color: #d97706;      /* amber-600 */
  --danger-color:  #dc2626;      /* red-600 */

  --bg-color: #f8fafc;           /* slate-50 */
  --panel-color: #ffffff;        /* white */
  --text-color: #0f172a;         /* slate-900 */
  --muted-text: #475569;         /* slate-600 */
  --border-color: rgba(15,23,42,.12);
}

/* General layout cleanup */
.admin-theme body, .admin-theme .app-root, .admin-theme .root, .admin-theme .container {
  background: var(--bg-color) !important;
  color: var(--text-color) !important;
}

/* Common cards/panels */
.admin-theme .ui-frame,
.admin-theme .card,
.admin-theme .panel,
.admin-theme .box,
.admin-theme .sheet,
.admin-theme .sidebar,
.admin-theme .composer,
.admin-theme .chat-window {
  background: var(--panel-color) !important;
  border: 1px solid var(--border-color) !important;
  border-radius: 14px !important;
  box-shadow: 0 8px 24px -12px rgba(2,6,23,.12) !important;
  backdrop-filter: none !important;
}

/* Inputs */
.admin-theme input,
.admin-theme select,
.admin-theme textarea {
  background: #fff !important;
  color: var(--text-color) !important;
  border: 1px solid var(--border-color) !important;
  border-radius: 12px !important;
  outline: none !important;
}
.admin-theme input:focus,
.admin-theme select:focus,
.admin-theme textarea:focus {
  border-color: var(--primary-color) !important;
  box-shadow: 0 0 0 3px rgba(37,99,235,.18) !important;
}

/* Buttons */
.admin-theme button,
.admin-theme .btn {
  border-radius: 12px !important;
  border: 1px solid var(--border-color) !important;
  background: #fff !important;
  color: var(--text-color) !important;
  cursor: pointer;
}
.admin-theme .primary-btn,
.admin-theme .btn-primary {
  color: #fff !important;
  background: linear-gradient(180deg, var(--primary-color), var(--primary-color-2)) !important;
  border: 1px solid rgba(37,99,235,.4) !important;
  box-shadow: 0 8px 18px -8px rgba(37,99,235,.25) !important;
}
.admin-theme .success, .admin-theme .badge-success { color:#fff !important; background: var(--success-color) !important; }
.admin-theme .warning, .admin-theme .badge-warning { color:#fff !important; background: var(--warning-color) !important; }
.admin-theme .danger,  .admin-theme .badge-danger  { color:#fff !important; background: var(--danger-color) !important; }

/* Reduce visual noise */
.admin-theme * { text-shadow: none !important; }
.admin-theme .glow, .admin-theme .neon, .admin-theme [class*="neon"], .admin-theme [style*="text-shadow"] {
  text-shadow: none !important; filter: none !important;
}
.admin-theme .logo-rainbow, .admin-theme .pilot-name, .admin-theme .flashing-warning, .admin-theme .flashing-danger-icon {
  animation: none !important;
}

/* Scrollbar */
.admin-theme ::-webkit-scrollbar { width: 10px; height: 10px; }
.admin-theme ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 8px; }
.admin-theme ::-webkit-scrollbar-track { background: transparent; }

/* Chat bubbles neutralized */
.admin-theme .bubble,
.admin-theme .message,
.admin-theme .chip {
  border: 1px solid var(--border-color) !important;
  background: #fff !important;
  color: var(--text-color) !important;
}

/* Utility */
.admin-theme .muted { color: var(--muted-text) !important; }
</style>

</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="root"></div>

    <script type="module">
        // Three.js background setup
        import * as THREE from 'three';
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#bg-canvas'),
            alpha: true,
            antialias: true,
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.z = 5;
        const particleCount = 1500;
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        const color = new THREE.Color();
        for (let i = 0; i < particleCount; i++) {
            const x = (Math.random() - 0.5) * 10;
            const y = (Math.random() - 0.5) * 10;
            const z = (Math.random() - 0.5) * 10;
            positions[i * 3] = x;
            positions[i * 3 + 1] = y;
            positions[i * 3 + 2] = z;
            const randomColor = Math.random();
            if (randomColor > 0.66) color.set(0x7dd3fc);
            else if (randomColor > 0.33) color.set(0xffffff);
            else color.set(0x22d3ee);
            colors[i * 3] = color.r;
            colors[i * 3 + 1] = color.g;
            colors[i * 3 + 2] = color.b;
        }
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: 0.025, vertexColors: true, transparent: true, opacity: 0.8, depthWrite: false });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX - window.innerWidth / 2) / 1000;
            mouseY = (event.clientY - window.innerHeight / 2) / 1000;
        });
        const clock = new THREE.Clock();
        const animate = () => {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();
            particles.rotation.y = elapsedTime * 0.1;
            particles.rotation.x = elapsedTime * 0.05;
            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;
            camera.lookAt(scene.position);
            renderer.render(scene, camera);
        };
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, orderBy, query, serverTimestamp, addDoc, updateDoc, writeBatch, getDocs, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, update, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        
        const { useState, useEffect, useRef, Fragment } = React;

        // --- START: Sửa lỗi cấu hình Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
            authDomain: "long-bao-tool-ai.firebaseapp.com",
            projectId: "long-bao-tool-ai",
            storageBucket: "long-bao-tool-ai.appspot.com",
            messagingSenderId: "259613170671",
            appId: "1:259613170671:web:55291d0b0af4e69052b41a",
            measurementId: "G-7V7H3JWX7K",
            databaseURL: "https://long-bao-tool-ai-default-rtdb.firebaseio.com" // Đã sửa lại URL
        };
        // --- END: Sửa lỗi cấu hình Firebase ---

        const ADMIN_USERNAME = "admin";
        const DUMMY_DOMAIN = "@long-bao-tool-ai.web.app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const storage = getStorage(app);

        const BACARAT_TABLES = ["BACARAT C04", "BACARAT C05", "BACARAT C06", "BACARAT C07", "BACARAT C01", "BACARAT C02", "BACARAT C03", "BACARAT C08", "BACARAT C09", "BACARAT C10", "BACARAT 1", "BACARAT 2", "BACARAT 3", "BACARAT 4", "BACARAT 5", "BACARAT 7", "BACARAT 8", "BACARAT 9", "BACARAT 10", "BACARAT C11", "BACARAT C12", "BACARAT C13", "BACARAT C15"];
        const MAX_ENERGY = 100;
        
        const sfx = {
            boot: () => new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("C3", "8n"),
            typing: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.0006, decay: 0.1, sustain: 0 } }).toDestination(),
            confirm: () => new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination().triggerAttackRelease("C5", "8n"),
            logout: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.2 } }).toDestination().triggerAttackRelease("C4", "4n"),
            error: () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0 } }).toDestination().triggerAttackRelease("8n"),
            notification: () => new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.1 } }).toDestination().triggerAttackRelease("G5", "16n", Tone.now() + 0.1).triggerAttackRelease("C6", "16n", Tone.now() + 0.2),
            blessing: () => new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.2, decay: 0.3, sustain: 0.5, release: 0.5 } }).toDestination().triggerAttackRelease("A4", "2n"),
            reaction: () => new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination().triggerAttackRelease("A5", "16n"),
        };

        const AnimatedPresence = ({ isVisible, children }) => {
            const [shouldRender, setShouldRender] = useState(isVisible);
            useEffect(() => {
                if (isVisible) setShouldRender(true);
                else { const timer = setTimeout(() => setShouldRender(false), 500); return () => clearTimeout(timer); }
            }, [isVisible]);
            if (!shouldRender) return null;
            return React.cloneElement(children, { className: `${children.props.className || ''} ${isVisible ? 'fade-in' : 'fade-out'}` });
        };
        
        const Modal = ({ children, onClose, size = 'md' }) => (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 fade-in" onClick={onClose}>
                <div className={`w-full max-w-${size} ui-frame`} onClick={e => e.stopPropagation()}>{children}</div>
            </div>
        );

        const MessageRenderer = ({ msg, currentUser, onImageClick, viewType = 'user', editingMsg, onStartEdit, onSaveEdit, onCancelEdit, onUpdateEditingText }) => {
            if (!msg || !msg.type) { return null; }
            const isEditingThisMessage = editingMsg?.id === msg.id;
            let isMyMessage, isPeerMessage;
            if (viewType === 'user') {
                isMyMessage = msg.senderId === currentUser?.uid;
                isPeerMessage = !isMyMessage && msg.senderId !== 'AQUARIUS_SYSTEM';
            } else {
                isPeerMessage = msg.senderId !== currentUser?.uid && msg.senderId !== 'AQUARIUS_SYSTEM';
                isMyMessage = msg.senderId === currentUser?.uid;
            }
            const isSystemMessage = msg.senderId === 'AQUARIUS_SYSTEM';
            const renderContent = () => {
                if (isEditingThisMessage && msg.type === 'text') {
                    return (
                        <div className="flex flex-col gap-2">
                            <textarea value={editingMsg.text} onChange={(e) => onUpdateEditingText(e.target.value)} className="w-full form-input bg-white text-sm" rows="3" />
                            <div className="flex justify-end gap-2">
                                <button onClick={onCancelEdit} className="secondary-btn text-xs px-3 py-1">Hủy</button>
                                <button onClick={onSaveEdit} className="primary-btn text-xs px-3 py-1">Lưu</button>
                            </div>
                        </div>
                    );
                }
                switch (msg.type) {
                    case 'future_request':
                        return (
                            <div className="p-3 rounded-lg bg-blue-50 border border-blue-300">
                                <p className="text-xs uppercase tracking-wider text-blue-500 font-semibold">CẦU TƯƠNG LAI</p>
                                <p className="text-slate-800">
                                    Sảnh: <span className="font-bold">{msg.content?.lobby}</span>
                                    {'  '}|{'  '}
                                    Bàn: <span className="font-bold">{msg.content?.tableName}</span>
                                </p>
                                {msg.content?.note && (
                                  <p className="text-slate-600 text-sm mt-1">Ghi chú: {msg.content.note}</p>
                                )}
                            </div>
                        );
                    case 'future_grid':
                        const raw = msg.content?.grid;
                        let rows = 0, cols = 0, cells = [];
                        if (Array.isArray(raw)) { // legacy nested arrays (not used anymore)
                          rows = raw.length; cols = raw[0]?.length || 0; cells = raw.flat();
                        } else if (raw && Array.isArray(raw.cells)) {
                          rows = raw.rows || 0; cols = raw.cols || 0; cells = raw.cells;
                        }
                        return (
                          <div className="inline-block p-2 rounded-lg border bg-white">
                            <p className="text-xs text-slate-500 mb-2">
                              Sảnh: <span className="font-semibold">{msg.content?.lobby}</span>
                              {' '}| Bàn: <span className="font-semibold">{msg.content?.tableName}</span>
                            </p>
                            <div style={{ display: 'grid', gridTemplateColumns: `repeat(${cols}, 18px)`, gap: '2px' }}>
                              {Array.from({length: rows}).flatMap((_, r) =>
                                Array.from({length: cols}).map((_, c) => {
                                  const cell = cells[r*cols + c];
                                  return (
                                    <div key={`${r}-${c}`}
                                         style={{ width: '18px', height: '18px', border: '1px solid #e5e7eb',
                                                  borderRadius: '9999px', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                  backgroundColor: cell === 'P' ? '#2563eb' : (cell === 'B' ? '#dc2626' : 'white'),
                                                  color: (cell === 'P' || cell === 'B') ? 'white' : 'transparent', fontSize: '10px', fontWeight: 700 }}>
                                      {cell === 'P' ? 'P' : (cell === 'B' ? 'B' : '')}
                                    </div>
                                  );
                                })
                              )}
                            </div>
                          </div>
                        );
case 'text': return <p className="whitespace-pre-wrap">{msg.text}</p>;
                    case 'image': return <img src={msg.content?.url} alt="Hình ảnh" className="max-w-[200px] sm:max-w-xs md:max-w-sm rounded-lg cursor-pointer" onClick={() => onImageClick && onImageClick(msg.content?.url)} onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x300/f87171/white?text=Lỗi+Ảnh'; }} />;
                    case 'warning': return <div className="p-3 border-l-4 border-amber-500 bg-amber-50 rounded-r-lg flashing-warning"><p className="font-semibold text-amber-700">Cảnh Báo Hệ Thống</p><p className="text-slate-700">{msg.content?.text}</p></div>;
                    case 'wait': return <div className="p-3 border-l-4 border-sky-500 bg-sky-50 rounded-r-lg"><p className="text-slate-700">{msg.content?.text}</p></div>;
                    case 'prediction':
                        const isCai = msg.content?.prediction === 'Nhà Cái'; const isCon = msg.content?.prediction === 'Nhà Con'; const bgColor = isCai ? 'bg-red-600' : isCon ? 'bg-blue-600' : 'bg-green-600';
                        return (<div className={`p-3 text-center rounded-lg ${bgColor} text-white shadow-lg min-w-[150px]`}><p className="text-xs uppercase tracking-wider text-slate-200">{msg.content?.table}</p><p className="text-2xl font-bold font-orbitron">{msg.content?.prediction}</p></div>);
                    case 'result':
                        const isWin = msg.content?.result === 'Thắng';
                        return (<div className={`p-3 text-center rounded-lg shadow-lg ${isWin ? 'bg-gradient-to-br from-green-500 to-green-600' : 'bg-gradient-to-br from-red-500 to-red-600'} text-white`}><p className="text-2xl font-bold font-orbitron">{msg.content?.result}!</p>{msg.content?.message && <p className="text-sm">{msg.content.message}</p>}</div>);
                    case 'broadcast': return (<div className="p-4 border-2 border-[var(--success-color)] bg-green-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'rgba(22, 163, 74, 0.5)'}}><h4 className="text-xl font-bold text-[var(--success-color)] uppercase tracking-widest">THÔNG BÁO HỆ THỐNG</h4><p className="text-xl font-semibold text-slate-800">{msg.content?.text}</p></div>);
                    case 'emergency': return (<div className="p-4 border-2 border-[var(--danger-color)] bg-red-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'rgba(220, 38, 38, 0.7)'}}><div className="flex justify-center items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-[var(--danger-color)] flashing-danger-icon rounded-full p-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><h4 className="text-xl font-bold text-[var(--danger-color)] uppercase tracking-widest">TIN NHẮN KHẨN CẤP</h4></div><p className="text-xl font-semibold text-slate-800">{msg.content?.text}</p></div>);
                    case 'table_announcement': return (<div className="p-4 border-2 border-[var(--primary-color)] bg-blue-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'rgba(37, 99, 235, 0.5)'}}><h4 className="text-xl font-bold text-[var(--primary-color)] uppercase tracking-widest">XÁC NHẬN BÀN</h4><p className="text-2xl font-bold text-slate-800 font-orbitron">{msg.content?.table}</p></div>);
                    case 'blessing': return (<div className="p-4 border-2 border-pink-400 bg-pink-50 rounded-lg text-center space-y-2 pulse-announcement" style={{'--glow-color': 'rgba(219, 39, 119, 0.5)'}}><h4 className="text-xl font-bold text-pink-500 uppercase tracking-widest">BAN PHƯỚC</h4><p className="text-lg font-semibold text-slate-700">{msg.content?.plea}</p><p className="text-2xl font-bold text-pink-600 font-orbitron">{msg.content?.blessing}</p><p className="text-sm text-slate-500">Năng lượng đã được cộng thêm.</p></div>);
                    case 'blessing_request': return (<div className="p-3 border-l-4 border-pink-400 bg-pink-50 rounded-r-lg"><p className="font-semibold text-pink-700">Gửi lời thỉnh cầu:</p><p className="text-slate-700 italic">"{msg.content?.plea}"</p></div>);
                    case 'info_submission': return (<div className="p-3 border-l-4 border-slate-400 bg-slate-100 rounded-r-lg"><p className="font-semibold text-slate-700">Hệ thống ghi nhận:</p><p className="text-slate-600">{msg.content?.text}</p></div>);
                    default: return null;
                }
            };
            if (isSystemMessage || ['broadcast', 'blessing', 'warning', 'info_submission', 'table_announcement', 'emergency'].includes(msg.type)) {
                return <div className="flex justify-center my-4 w-full">{renderContent()}</div>;
            }
            const alignment = isPeerMessage ? 'items-start' : 'items-end';
            const bubbleStyle = isPeerMessage ? { background: 'linear-gradient(135deg, #ffffff, #f1f5f9)', color: 'var(--text-color)', border: '1px solid var(--border-color)', borderRadius: '1rem 1rem 1rem 0.25rem'} : { background: 'linear-gradient(135deg, #2563eb, #3b82f6)', color: 'white', borderRadius: '1rem 1rem 0.25rem 1rem' };
            return (
                <div className={`group flex flex-col my-2 ${alignment}`}>
                    <div className="max-w-lg relative">
                       <div style={bubbleStyle} className="p-2 sm:p-3">{renderContent()}</div>
                       {viewType === 'admin' && msg.type === 'text' && !isEditingThisMessage && (
                           <div className="absolute top-0 -left-8 opacity-0 group-hover:opacity-100 transition-opacity">
                               <button onClick={() => onStartEdit(msg)} className="p-1.5 bg-white rounded-full shadow-md hover:bg-slate-200">
                                   <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>
                               </button>
                           </div>
                       )}
                    </div>
                </div>
            );
        };
        
        const SplashScreen = () => (
            <div className="h-full w-full flex flex-col items-center justify-center bg-slate-100 fade-in">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="mx-auto mb-4" style={{color: 'var(--primary-color)'}}>
                    <path d="M12 2L3 21H21L12 2Z" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round" strokeLinecap="round"/>
                    <path d="M7.5 14C8 13 9 12.5 10.5 12.5C12 12.5 13 13.5 14.5 13.5C16 13.5 17 12.5 17.5 12" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                    <path d="M7.5 17C8 16 9 15.5 10.5 15.5C12 15.5 13 16.5 14.5 16.5C16 16.5 17 15.5 17.5 15" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                </svg>
                <h1 className="text-5xl font-black font-orbitron"><span className="logo-rainbow">AQUARIUS V</span></h1>
                <p className="text-[var(--primary-color)] tracking-[0.2em] font-bold font-tech-mono mt-2">SIÊU TRÍ TUỆ</p>
            </div>
        );

        const LoginScreen = () => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const handleLogin = async (e) => {
                e.preventDefault(); setIsLoading(true); setError(''); await Tone.start();
                const email = username.trim().toLowerCase() + DUMMY_DOMAIN;
                try { await signInWithEmailAndPassword(auth, email, password); sfx.confirm(); } 
                catch (err) { sfx.error(); setError("Xác thực thất bại. Vui lòng kiểm tra lại."); } 
                finally { setIsLoading(false); }
            };
            const handleSignup = async () => {
                setIsLoading(true); setError(''); await Tone.start();
                const processedUsername = username.trim().toLowerCase();
                if (!processedUsername || !password) { sfx.error(); setError("Vui lòng nhập đủ thông tin."); setIsLoading(false); return; }
                if (password.length < 6) { sfx.error(); setError("Mật khẩu phải có ít nhất 6 ký tự."); setIsLoading(false); return; }
                const email = processedUsername + DUMMY_DOMAIN;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, "users", userCredential.user.uid);
                    await setDoc(userDocRef, { uid: userCredential.user.uid, username: processedUsername, createdAt: serverTimestamp(), energy: 7, hasSubmittedInfo: false, lastBlessingTimestamp: null, lastLoanRequestTimestamp: null, messageCountToday: 0, lastMessageDate: "", avatarUrl: `https://placehold.co/96x96/e2e8f0/64748b?text=${processedUsername.charAt(0).toUpperCase()}` });
                    sfx.confirm();
                } catch (err) {
                    sfx.error();
                    if (err.code === 'auth/email-already-in-use') setError("Mã hiệu này đã được sử dụng.");
                    else setError("Không thể tạo tài khoản mới.");
                } finally { setIsLoading(false); }
            };
            return (
                <div className="h-full w-full flex items-center justify-center p-4">
                    <div className="w-full max-w-md ui-frame fade-in">
                        <div className="text-center mb-8">
                            <svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="mx-auto mb-4" style={{color: 'var(--primary-color)'}}>
                                <path d="M12 2L3 21H21L12 2Z" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round" strokeLinecap="round"/>
                                <path d="M7.5 14C8 13 9 12.5 10.5 12.5C12 12.5 13 13.5 14.5 13.5C16 13.5 17 12.5 17.5 12" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                                <path d="M7.5 17C8 16 9 15.5 10.5 15.5C12 15.5 13 16.5 14.5 16.5C16 16.5 17 15.5 17.5 15" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/>
                            </svg>
                            <h1 className="text-4xl font-black font-orbitron"><span className="logo-rainbow">AQUARIUS V</span></h1>
                            <p className="text-[var(--primary-color)] tracking-[0.2em] font-bold font-tech-mono">SIÊU TRÍ TUỆ</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <input value={username} onChange={e => setUsername(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="text" placeholder="Mã hiệu Pilot" className="w-full form-input font-tech-mono" />
                            <input value={password} onChange={e => setPassword(e.target.value)} onKeyDown={() => sfx.typing.triggerAttack("C1")} type="password" placeholder="Mật khẩu" className="w-full form-input font-tech-mono" />
                            {error && <p className="text-red-600 text-center text-sm font-semibold">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full primary-btn">{isLoading ? 'ĐANG KẾT NỐI...' : 'KẾT NỐI'}</button>
                        </form>
                        <div className="text-center mt-6">
                            <button onClick={handleSignup} disabled={isLoading} className="font-semibold text-[var(--primary-color)] hover:text-blue-800 text-sm font-tech-mono">Chưa có tài khoản? Khởi tạo</button>
                        </div>

                        {/* START: Added App Download Buttons */}
                        <div className="text-center mt-8 pt-6 border-t border-slate-200">
                            <p className="text-xs text-slate-400 mb-4 font-tech-mono uppercase tracking-wider">Tải ứng dụng</p>
                            <div className="flex justify-center items-center gap-4">
                                <a href="https://limewire.com/d/s5gEv#2jiidofoh4" target="_blank" rel="noopener noreferrer" className="hover:opacity-80 transition-opacity">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Google_Play_Store_badge_EN.svg/1280px-Google_Play_Store_badge_EN.svg.png" alt="Tải về từ Google Play" className="h-12" />
                                </a>
                                <a href="#" rel="noopener noreferrer" className="hover:opacity-80 transition-opacity">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Download_on_the_App_Store_Badge.svg/1280px-Download_on_the_App_Store_Badge.svg.png" alt="Tải về từ App Store" className="h-12" />
                                </a>
                            </div>
                        </div>
                        {/* END: Added App Download Buttons */}

                    </div>
                </div>
            );
        };
        
        const SystemStatusBanner = ({ status }) => {
            if (!status || !status.message) return null; 

            const isOnline = status.isOnline;
            const bgColor = isOnline ? 'bg-green-100 border-green-500' : 'bg-slate-200 border-slate-400';
            const textColor = isOnline ? 'text-green-800' : 'text-slate-700';
            const iconColor = isOnline ? 'text-green-500' : 'text-slate-500';
            const iconPath = isOnline 
                ? "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                : "M11 7h2v6h-2zm0 8h2v2h-2zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z";

            return (
                <div className={`p-2 sm:p-3 border-b ${bgColor} flex items-center space-x-3 transition-all duration-300 flex-shrink-0`}>
                    <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 flex-shrink-0 ${iconColor}`} viewBox="0 0 24 24" fill="currentColor">
                        <path d={iconPath}></path>
                    </svg>
                    <p className={`text-sm font-semibold ${textColor} truncate`}>{status.message}</p>
                </div>
            );
        };

        const UserView = ({ currentUser, onLogout }) => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [userData, setUserData] = useState(null);
            const [showBlessingModal, setShowBlessingModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showInfoModal, setShowInfoModal] = useState(false);
            const [showImageModal, setShowImageModal] = useState(null);
            // === FUTURE PREDICTION – STATE ===
            const [showFutureModal, setShowFutureModal] = useState(false);
            const [showVipGate, setShowVipGate] = useState(false);
            const [futureForm, setFutureForm] = useState({ lobby: 'DG', tableName: '', note: '' });
            const [sendingFuture, setSendingFuture] = useState(false);
    
            const [plea, setPlea] = useState('');
            const [infoFormData, setInfoFormData] = useState({ f168Account: '', capital: '', target: '' });
            const [isAdminTyping, setIsAdminTyping] = useState(false);
            const [blessingCooldown, setBlessingCooldown] = useState("");
            const [isSending, setIsSending] = useState(false);
            const [isUploadingAvatar, setIsUploadingAvatar] = useState(false);
            const [systemStatus, setSystemStatus] = useState({ isOnline: true, message: '' });
            const messagesEndRef = useRef(null);
            const avatarInputRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isAdminTyping]);
            useEffect(() => { if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") { Notification.requestPermission(); } }, []);
            
            useEffect(() => {
                const statusRef = ref(rtdb, 'system_status');
                const unsub = onValue(statusRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setSystemStatus(data);
                    } else {
                        setSystemStatus({ isOnline: true, message: 'Hệ thống đang hoạt động bình thường.' });
                    }
                });
                return () => unsub();
            }, []);

            const useCooldownTimer = (lastTimestamp, setCooldownString) => {
                 useEffect(() => {
                     if (!userData || !lastTimestamp) { setCooldownString(""); return; }
                     const interval = setInterval(() => {
                         const now = Date.now();
                         const lastTime = lastTimestamp.toMillis();
                         const twentyFourHours = 24 * 60 * 60 * 1000;
                         const timePassed = now - lastTime;
                         if (timePassed < twentyFourHours) {
                             const timeLeft = twentyFourHours - timePassed;
                             const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                             const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                             const seconds = Math.floor((timeLeft / 1000) % 60);
                             setCooldownString(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                         } else { setCooldownString(""); clearInterval(interval); }
                     }, 1000);
                     return () => clearInterval(interval);
                 }, [userData, lastTimestamp]);
            }
            useCooldownTimer(userData?.lastBlessingTimestamp, setBlessingCooldown);
            useEffect(() => {
                if (!currentUser || !userData) return;
                const todayStr = new Date().toISOString().split('T')[0];
                if (userData.lastMessageDate !== todayStr) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    updateDoc(userDocRef, { messageCountToday: 0, lastMessageDate: todayStr });
                }
            }, [currentUser, userData]);
            useEffect(() => {
                if (!currentUser) return;
                const userDocRef = doc(db, 'users', currentUser.uid);
                const unsubUser = onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setUserData(data);
                        if(data.hasSubmittedInfo !== true) setShowInfoModal(true);
                    }
                });
                const messagesColRef = collection(db, 'user_chats', currentUser.uid, 'messages');
                const q = query(messagesColRef, orderBy('timestamp'));
                const unsubMessages = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const newMessage = change.doc.data();
                            if (newMessage.senderId !== currentUser.uid) {
                                sfx.notification();
                                if (newMessage.type === 'emergency') { sfx.error(); }
                                if (document.hidden && Notification.permission === "granted") {
                                    new Notification("Tin nhắn mới từ Aquarius", { body: newMessage.text || "Bạn có một tin nhắn mới.", icon: "https://placehold.co/96x96/2563eb/white?text=A" });
                                }
                            }
                        }
                    });
                    setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const typingRef = ref(rtdb, `typing_status/${currentUser.uid}/admin`);
                const unsubTyping = onValue(typingRef, (snapshot) => setIsAdminTyping(snapshot.val()?.isTyping || false));
                return () => { unsubUser(); unsubMessages(); unsubTyping(); };
            }, [currentUser]);
            const handleSendMessage = async () => {
                const content = inputMessage.trim();
                if (content === '' || isSending || !userData) return;
                setIsSending(true);
                const userDocRef = doc(db, 'users', currentUser.uid);
                const messageCount = userData.messageCountToday || 0;
                const isFree = messageCount < 2;
                const canAfford = userData.energy >= 7;
                if (!isFree && !canAfford) {
                    sfx.error();
                    await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'warning', content: { text: 'Không đủ năng lượng để gửi tin nhắn.' }, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp(), reactions: {} });
                    setIsSending(false); return;
                }
                sfx.confirm();
                try {
                    const username = currentUser.email.split('@')[0];
                    await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'text', text: content, senderId: currentUser.uid, timestamp: serverTimestamp(), reactions: {} });
                    await setDoc(doc(db, 'user_chats', currentUser.uid), { lastUpdate: serverTimestamp(), username: username, userId: currentUser.uid, isRead: false, avatarUrl: userData.avatarUrl || `https://placehold.co/96x96/e2e8f0/64748b?text=${username.charAt(0).toUpperCase()}` }, { merge: true });
                    const updates = { messageCountToday: increment(1) };
                    if (!isFree) { updates.energy = increment(-7); }
                    await updateDoc(userDocRef, updates);
                    setInputMessage('');
                } catch (error) { console.error("Error sending message:", error); sfx.error(); } 
                finally { setIsSending(false); }
            };
            const handleBlessingRequest = async () => {
                if (!plea.trim() || blessingCooldown) return;
                sfx.blessing();
                const userDocRef = doc(db, 'users', currentUser.uid);
                await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'blessing_request', content: { plea: plea.trim() }, senderId: currentUser.uid, timestamp: serverTimestamp(), reactions: {} });
                await updateDoc(userDocRef, { lastBlessingTimestamp: serverTimestamp() });
                setShowBlessingModal(false); setPlea('');
            };
            // === FUTURE PREDICTION – HANDLER ===
            const handleSendFuture = async () => {
                if (!userData || (userData.energy ?? 0) < 50) { sfx.error(); await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'warning', content: { text: 'Không đủ năng lượng (cần 50) để dùng Cầu Tương Lai.' }, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp(), reactions: {} }); return; }
                if (!futureForm.tableName.trim()) { sfx.error(); return; }
                try {
                    setSendingFuture(true);
                    await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), {
                        type: 'future_request',
                        content: {
                            lobby: futureForm.lobby,
                            tableName: futureForm.tableName.trim(),
                            note: futureForm.note?.trim() || null
                        },
                        senderId: currentUser.uid,
                        timestamp: serverTimestamp(),
                        reactions: {}
                    });
                    sfx.confirm();
                    // trừ 50 năng lượng
                    await updateDoc(doc(db, 'users', currentUser.uid), { energy: increment(-50) });
                    setShowFutureModal(false);
                    setFutureForm({ lobby: 'DG', tableName: '', note: '' });
                } catch (error) { console.error(error); sfx.error(); }
                finally { setSendingFuture(false); }
            };
        
            const handleInfoSubmit = async () => {
                if (!infoFormData.f168Account || !infoFormData.capital || !infoFormData.target) { sfx.error(); return; }
                sfx.confirm();
                const userDocRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userDocRef, { ...infoFormData, hasSubmittedInfo: true });
                await addDoc(collection(db, 'user_chats', currentUser.uid, 'messages'), { type: 'info_submission', content: { text: `Báo cáo đã được gửi: TK F168(${infoFormData.f168Account}), Vốn(${infoFormData.capital}), Mục tiêu(${infoFormData.target})` }, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp(), reactions: {} });
                setShowInfoModal(false);
            };
            const handleAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploadingAvatar(true);
                const filePath = `avatars/${currentUser.uid}/${file.name}`;
                const fileRef = storageRef(storage, filePath);
                const uploadTask = uploadBytesResumable(fileRef, file);
                uploadTask.on('state_changed', null, (error) => { console.error("Avatar upload error", error); sfx.error(); setIsUploadingAvatar(false); }, () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        await updateDoc(doc(db, "users", currentUser.uid), { avatarUrl: downloadURL });
                        setIsUploadingAvatar(false); sfx.confirm();
                    });
                });
            };
            if (!userData) return null;
            const TypingIndicator = () => (<div className="flex mb-4 justify-start"><div className="p-3 rounded-2xl rounded-bl-lg" style={{ background: 'linear-gradient(135deg, #ffffff, #f1f5f9)', border: '1px solid var(--border-color)'}}><div className="flex items-center space-x-1"><div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div><div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div><div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div></div></div></div>);
            const EnergyBar = ({ current, max }) => {
                const percentage = Math.min(100, (current / max) * 100);
                return (<div className="w-full"><div className="flex justify-between items-center mb-1"><span className="text-xs font-bold text-[var(--primary-color)]">NĂNG LƯỢNG</span><span className="text-xs font-bold text-slate-600">{current}/{max}</span></div><div className="w-full bg-slate-200 rounded-full h-2"><div className="bg-gradient-to-r from-blue-500 to-cyan-400 h-2 rounded-full transition-all duration-500" style={{ width: `${percentage}%` }}></div></div></div>);
            };
            const BlessingHistoryModal = ({ messages, onClose, currentUser }) => {
                const blessingMessages = messages.filter(msg => msg.type === 'blessing').sort((a, b) => b.timestamp - a.timestamp);
                return (<Modal onClose={onClose} size="lg"><h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Lịch sử Ban Phước</h3><div className="max-h-[60vh] overflow-y-auto custom-scrollbar space-y-4 p-4 bg-slate-100 rounded-lg">{blessingMessages.length > 0 ? blessingMessages.map(msg => (<div key={msg.id} className="bg-white rounded-lg shadow-sm p-2"><MessageRenderer msg={msg} currentUser={currentUser} viewType="user" /><p className="text-xs text-right text-slate-400 pt-2">{new Date(msg.timestamp?.toDate()).toLocaleString()}</p></div>)) : <p className="text-center text-slate-500">Chưa có lịch sử.</p>}</div><div className="flex justify-end mt-4"><button onClick={onClose} className="primary-btn">Đóng</button></div></Modal>);
            };
            const sendDisabled = isSending || ((userData?.messageCountToday || 0) >= 2 && userData.energy < 7) || !systemStatus.isOnline;
            return (
                <Fragment>
                    <div className="h-full w-full flex items-center justify-center p-2 sm:p-4">
                        <div className="w-full h-full max-w-lg sm:max-w-2xl ui-frame flex flex-col overflow-hidden">
                            <header className="p-2 sm:p-4 flex-shrink-0 border-b border-[var(--border-color)]">
                                <div className="flex justify-between items-center space-x-2">
                                    <div className="flex-1 flex items-center space-x-3 overflow-hidden">
                                        <div className="relative group flex-shrink-0">
                                            <img src={userData.avatarUrl} alt="Avatar" className="w-10 h-10 sm:w-14 sm:h-14 rounded-full border-2 border-white shadow-md cursor-pointer" onClick={() => avatarInputRef.current.click()} onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/96x96/e2e8f0/64748b?text=${userData.username.charAt(0).toUpperCase()}`; }} />
                                            <input type="file" ref={avatarInputRef} onChange={handleAvatarUpload} accept="image/*" className="hidden" />
                                            <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">{isUploadingAvatar ? <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> : "Đổi"}</div>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h2 className="text-base sm:text-xl font-bold text-slate-800 truncate">PILOT: <span className="pilot-name">{currentUser.email.split('@')[0].toUpperCase()}</span></h2>
                                            <EnergyBar current={userData.energy} max={MAX_ENERGY} />
                                        </div>
                                    </div>
                                    <div className="flex flex-col space-y-1.5">
                                        <button onClick={() => setShowHistoryModal(true)} className="secondary-btn px-2.5 py-1 text-xs whitespace-nowrap">Lịch sử</button>
                                        <button onClick={onLogout} className="secondary-btn px-2.5 py-1 text-xs whitespace-nowrap">Ngắt kết nối</button>
                                    </div>
                                </div>
                            </header>
                            
                            <SystemStatusBanner status={systemStatus} />

                            <main className="flex-1 p-2 sm:p-4 overflow-y-auto custom-scrollbar">
                               {messages.map(msg => <MessageRenderer key={msg.id} msg={msg} currentUser={currentUser} viewType="user" onImageClick={setShowImageModal} />)}
                               {isAdminTyping && <TypingIndicator />}
                               <div ref={messagesEndRef} />
                            </main>
                            
                            <footer className="p-2 sm:p-4 flex-shrink-0 border-t border-[var(--border-color)] space-y-3">
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => setShowBlessingModal(true)} disabled={!!blessingCooldown} className="primary-btn p-2 sm:px-4 disabled:opacity-50" style={{'--primary-color': 'var(--secondary-color)'}}>
                                        {blessingCooldown ? <span className="font-tech-mono text-xs">{blessingCooldown}</span> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>}
                                    </button>
                                    <button
                                        onClick={() => setShowVipGate(true)}
                                        className="relative flex items-center gap-2 p-2 sm:px-4 rounded-xl font-orbitron text-sm uppercase tracking-wider shadow-md hover:shadow-lg transition-all active:scale-[0.99] bg-gradient-to-r from-cyan-400 via-cyan-500 to-cyan-600 text-black"
                                        style={{ letterSpacing: '0.06em' }}
                                    >
                                        <span className="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/80">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                        </span>
                                        <span>Cầu tương lai</span>
                                        <span className="absolute -top-2 -right-2 text-[10px] font-black px-2 py-0.5 rounded-full bg-black/80 text-yellow-300 border border-yellow-400/50">VIP</span>
                                    </button>
                                </div>
                                <div className="signal-composer">
                                    <textarea
                                        value={inputMessage}
                                        onChange={e => setInputMessage(e.target.value)}
                                        onKeyDown={e => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter' && !sendDisabled) handleSendMessage(); }}
                                        placeholder={systemStatus.isOnline ? "Gửi tín hiệu... (Ctrl/Cmd + Enter để gửi)" : "Hệ thống đang Offline"}
                                        className="w-full form-input signal-input" style={{backgroundColor:'white',color:'black',boxShadow:'inset 0 1px 2px rgba(0,0,0,.12)'}}
                                        disabled={!systemStatus.isOnline}
                                        rows="3"
                                    />
                                    <div className="flex items-center justify-between mt-2">
                                        <div className="text-xs font-tech-mono text-slate-400">
                                            {(userData?.messageCountToday || 0) < 2 ? `Miễn phí còn: ${2 - (userData?.messageCountToday || 0)}` : `Mỗi lần gửi tốn 7 năng lượng`}
                                        </div>
                                        <button onClick={handleSendMessage} disabled={sendDisabled} className="primary-btn px-4 sm:px-6">
                                            {isSending ? '...' : 'Gửi'}
                                        </button>
                                    </div>
                                </div>
                            </footer>
    
                        </div>
                    </div>
                    <AnimatedPresence isVisible={showBlessingModal}><Modal onClose={() => setShowBlessingModal(false)}><h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Thỉnh Cầu Ban Phước</h3><p className="text-center text-sm text-slate-500 mb-4">Chức năng này được dùng 1 lần mỗi 24 giờ và không tốn năng lượng.</p><textarea value={plea} onChange={e => setPlea(e.target.value)} className="w-full h-24 p-3 form-input" placeholder="Viết lời thỉnh cầu của bạn..."></textarea><div className="flex justify-end space-x-4 mt-4"><button onClick={() => setShowBlessingModal(false)} className="secondary-btn px-4 py-2">Hủy</button><button onClick={handleBlessingRequest} disabled={!plea.trim() || !!blessingCooldown} className="primary-btn px-4 py-2">Gửi</button></div></Modal></AnimatedPresence>

                    {/* VIP GATE MODAL */}
                    <AnimatedPresence isVisible={showVipGate}>
                      <Modal onClose={() => setShowVipGate(false)}>
                        <div className="text-center space-y-3">
                          <div className="mx-auto w-14 h-14 rounded-2xl flex items-center justify-center bg-gradient-to-br from-yellow-300 via-amber-400 to-orange-500 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7 text-slate-900" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                          </div>
                          <h3 className="text-2xl font-black text-slate-800">Tính năng VIP</h3>
                          <p className="text-sm sm:text-base font-semibold text-slate-700 leading-relaxed">
                            ĐÂY LÀ TÍNH NĂNG CHỈ DÀNH CHO THÀNH VIÊN <span className="text-amber-600">PREMIUM</span> VÀ <span className="text-amber-600">OMEGA</span>,<br/>
                            NẾU BẠN KHÔNG PHẢI XIN HÃY RỜI KHỎI.
                          </p>
                          <div className="flex justify-end gap-3 pt-2">
                            <button onClick={() => setShowVipGate(false)} className="secondary-btn px-4 py-2">Huỷ bỏ</button>
                            <button
                              onClick={() => { sfx.confirm(); setShowVipGate(false); setShowFutureModal(true); }}
                              className="primary-btn px-4 py-2"
                              style={{'--primary-color': 'var(--warning-color)'}}
                            >
                              Xác nhận
                            </button>
                          </div>
                        </div>
                      </Modal>
                    </AnimatedPresence>

                    {/* FUTURE MODAL */}
                    <AnimatedPresence isVisible={showFutureModal}>
                      <Modal onClose={() => setShowFutureModal(false)}>
                        <h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Cầu Tương Lai</h3><p className="text-center text-xs text-slate-500 mb-3">Mỗi lần dùng tốn <span className='font-semibold text-red-600'>50 năng lượng</span>.</p>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-semibold mb-1 text-slate-600">Chọn sảnh</label>
                            <select
                              value={futureForm.lobby}
                              onChange={e => setFutureForm(f => ({ ...f, lobby: e.target.value }))}
                              className="form-input w-full"
                            >
                              <option value="DG">DG</option>
                              <option value="SEXY">SEXY</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1 text-slate-600">Tên bàn</label>
                            <input
                              value={futureForm.tableName}
                              onChange={e => setFutureForm(f => ({ ...f, tableName: e.target.value }))}
                              placeholder="Ví dụ: BACARAT C04"
                              className="form-input w-full"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1 text-slate-600">Ghi chú (tuỳ chọn)</label>
                            <input
                              value={futureForm.note}
                              onChange={e => setFutureForm(f => ({ ...f, note: e.target.value }))}
                              placeholder="Thêm ghi chú nếu cần…"
                              className="form-input w-full"
                            />
                          </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                          <button onClick={() => setShowFutureModal(false)} className="secondary-btn px-4 py-2">Hủy</button>
                          <button onClick={handleSendFuture} disabled={!futureForm.tableName.trim() || sendingFuture || (userData?.energy ?? 0) < 50} className="primary-btn px-4 py-2">
                            {sendingFuture ? 'Đang gửi...' : 'Gửi Aquarius'}
                          </button>
                        </div>
                      </Modal>
                    </AnimatedPresence>
        
                    <AnimatedPresence isVisible={showInfoModal}><Modal onClose={() => {}}><h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Yêu Cầu Khai Báo</h3><div className="space-y-4"><input value={infoFormData.f168Account} onChange={e => setInfoFormData({...infoFormData, f168Account: e.target.value})} type="text" placeholder="Tên TK F168" className="w-full form-input" /><input value={infoFormData.capital} onChange={e => setInfoFormData({...infoFormData, capital: e.target.value})} type="text" placeholder="Số vốn" className="w-full form-input" /><input value={infoFormData.target} onChange={e => setInfoFormData({...infoFormData, target: e.target.value})} type="text" placeholder="Muốn lên bao nhiêu" className="w-full form-input" /></div><div className="flex justify-end mt-6"><button onClick={handleInfoSubmit} className="primary-btn w-full">Gửi Báo Cáo</button></div></Modal></AnimatedPresence>
                    <AnimatedPresence isVisible={showImageModal}><Modal onClose={() => setShowImageModal(null)} size="3xl"><img src={showImageModal} className="w-full h-auto max-h-[80vh] object-contain rounded-lg"/><div className="text-center mt-4"><button onClick={() => setShowImageModal(null)} className="primary-btn">Đóng</button></div></Modal></AnimatedPresence>
                    <AnimatedPresence isVisible={showHistoryModal}><BlessingHistoryModal messages={messages} onClose={() => setShowHistoryModal(false)} currentUser={currentUser} /></AnimatedPresence>
                </Fragment>
            );
        };

        const AdminDashboard = ({ currentUser, onLogout }) => {
            const [conversations, setConversations] = useState([]);
            const [currentChat, setCurrentChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [uploadingImage, setUploadingImage] = useState(false);
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [showBroadcastModal, setShowBroadcastModal] = useState(false);
            const [broadcastMessage, setBroadcastMessage] = useState('');
            const [selectedTable, setSelectedTable] = useState(BACARAT_TABLES[0]);
            const [editingMsg, setEditingMsg] = useState({ id: null, text: '' });
            const [warningInput, setWarningInput] = useState('');
            const [emergencyInput, setEmergencyInput] = useState('');
            // === FUTURE GRID – STATE ===
            const [showGridModal, setShowGridModal] = useState(false);
            const [gridInfo, setGridInfo] = useState({ lobby: 'DG', tableName: '' });
            const [gridData, setGridData] = useState(Array(6).fill(0).map(()=>Array(12).fill(null)));
    
            const [systemStatus, setSystemStatus] = useState({ isOnline: true, message: '' });
            const messagesEndRef = useRef(null);
            const imageInputRef = useRef(null);

            useEffect(() => {
                const statusRef = ref(rtdb, 'system_status');
                const unsub = onValue(statusRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setSystemStatus(data);
                    } else {
                        const defaultStatus = { isOnline: true, message: 'Hệ thống đang hoạt động bình thường.' };
                        set(statusRef, defaultStatus);
                        setSystemStatus(defaultStatus);
                    }
                });
                return () => unsub();
            }, []);

            const handleSystemStatusToggle = () => {
                const newStatus = !systemStatus.isOnline;
                const statusRef = ref(rtdb, 'system_status');
                update(statusRef, { isOnline: newStatus });
            };

            const handleStatusMessageChange = (e) => {
                 const newMessage = e.target.value;
                 setSystemStatus(prev => ({...prev, message: newMessage}));
                 const statusRef = ref(rtdb, 'system_status');
                 update(statusRef, { message: newMessage });
            };

            useEffect(() => { const q = query(collection(db, 'user_chats'), orderBy('lastUpdate', 'desc')); const unsub = onSnapshot(q, snapshot => setConversations(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))); return () => unsub(); }, []);
            useEffect(() => { if (!currentChat) return; setEditingMsg({ id: null, text: '' }); const q = query(collection(db, 'user_chats', currentChat.id, 'messages'), orderBy('timestamp')); const unsub = onSnapshot(q, snapshot => setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))); updateDoc(doc(db, 'user_chats', currentChat.id), { isRead: true }); return () => unsub(); }, [currentChat]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);
            useEffect(() => { const statusRef = ref(rtdb, 'status'); const unsub = onValue(statusRef, (snapshot) => { const users = []; snapshot.forEach((childSnapshot) => { const user = childSnapshot.val(); if (user.isOnline) { users.push({ uid: childSnapshot.key, ...user }); } }); setOnlineUsers(users); }); return () => unsub(); }, []);
            const handleTyping = (e) => { setInputMessage(e.target.value); if (!currentChat) return; const typingRef = ref(rtdb, `typing_status/${currentChat.id}/admin`); set(typingRef, { isTyping: e.target.value.length > 0 }); };
            const handleImageUpload = async (event) => {
                if (!currentChat) return; const file = event.target.files[0]; if (!file) return; setUploadingImage(true);
                const filePath = `chat_images/${currentChat.id}/${Date.now()}_${file.name}`; const fileRef = storageRef(storage, filePath);
                try { const snapshot = await uploadBytes(fileRef, file); const downloadURL = await getDownloadURL(snapshot.ref); await handleSendMessage('image', { url: downloadURL }); } 
                catch (error) { console.error("Lỗi tải lên hình ảnh:", error); sfx.error(); } 
                finally { setUploadingImage(false); if (imageInputRef.current) { imageInputRef.current.value = ""; } }
            };
            const handleSendMessage = async (type = 'text', content = null) => {
                if (!currentChat) return; const textContent = inputMessage.trim(); if (type === 'text' && textContent === '') return;
                try {
                    sfx.confirm(); let messageData = { senderId: currentUser.uid, timestamp: serverTimestamp(), reactions: {} };
                    if (type === 'text') { messageData.type = 'text'; messageData.text = textContent; } else { messageData.type = type; messageData.content = content; }
                    await addDoc(collection(db, 'user_chats', currentChat.id, 'messages'), messageData);
                    await updateDoc(doc(db, 'user_chats', currentChat.id), { lastUpdate: serverTimestamp(), isRead: true });
                    if (type === 'text') { setInputMessage(''); const typingRef = ref(rtdb, `typing_status/${currentChat.id}/admin`); set(typingRef, { isTyping: false }); }
                } catch (error) { console.error("Lỗi khi gửi tin nhắn:", error); sfx.error(); }
            };
            const handleStartEdit = (msg) => { setEditingMsg({ id: msg.id, text: msg.text || '' }); };
            const handleCancelEdit = () => { setEditingMsg({ id: null, text: '' }); };
            const handleSaveEdit = async () => {
                if (!editingMsg.id || !currentChat) return; const msgDocRef = doc(db, 'user_chats', currentChat.id, 'messages', editingMsg.id);
                try { await updateDoc(msgDocRef, { text: editingMsg.text, edited: true, editedAt: serverTimestamp() }); handleCancelEdit(); sfx.confirm(); } 
                catch (error) { console.error("Error updating message:", error); sfx.error(); }
            };
            const handleBroadcast = async () => {
                if (broadcastMessage.trim() === '' || conversations.length === 0) return; sfx.confirm();
                const batch = writeBatch(db);
                conversations.forEach(conv => {
                    const messageRef = doc(collection(db, 'user_chats', conv.id, 'messages'));
                    batch.set(messageRef, { type: 'broadcast', content: { text: broadcastMessage.trim() }, senderId: 'AQUARIUS_SYSTEM', timestamp: serverTimestamp(), reactions: {} });
                    const convRef = doc(db, 'user_chats', conv.id);
                    batch.update(convRef, { lastUpdate: serverTimestamp(), isRead: false });
                });
                await batch.commit(); setBroadcastMessage(''); setShowBroadcastModal(false);
            };
            const handleSendWarning = () => { if (!warningInput.trim() || !currentChat) return; handleSendMessage('warning', { text: warningInput.trim() }); setWarningInput(''); };
            const handleSendEmergency = () => { if (!emergencyInput.trim() || !currentChat) return; sfx.error(); handleSendMessage('emergency', { text: emergencyInput.trim() }); setEmergencyInput(''); };
            // === FUTURE GRID – HELPERS ===
            const cycleCell = (r, c) => {
                setGridData(prev => {
                    const g = prev.map(row => [...row]);
                    const v = g[r][c];
                    if (v === null) g[r][c] = 'P';
                    else if (v === 'P') g[r][c] = 'B';
                    else g[r][c] = null;
                    return g;
                });
            };
            const clearCell = (r, c) => {
                setGridData(prev => {
                    const g = prev.map(row => [...row]);
                    g[r][c] = null;
                    return g;
                });
            };
            const sendFutureGrid = async () => {
                if (!currentChat) return;
                if (!gridInfo.tableName.trim()) { sfx.error(); return; }
                try {
                    sfx.confirm();
                    const _rows = gridData.length; const _cols = gridData[0]?.length || 0; const _cells = []; for (let r=0;r<_rows;r++){ for(let c=0;c<_cols;c++){ _cells.push(gridData[r][c] ?? null); } }
                    await addDoc(collection(db, 'user_chats', currentChat.id, 'messages'), { type: 'future_grid', content: { lobby: gridInfo.lobby, tableName: gridInfo.tableName.trim(), grid: { rows: _rows, cols: _cols, cells: _cells } },
                        senderId: currentUser.uid,
                        timestamp: serverTimestamp(),
                        reactions: {}
                    });
                    await updateDoc(doc(db, 'user_chats', currentChat.id), { lastUpdate: serverTimestamp(), isRead: true });
                    setShowGridModal(false);
                } catch (e) { console.error(e); sfx.error(); }
            };
        
            return (
                 <Fragment>
                    <div className="h-full w-full flex items-center justify-center p-4">
                        <div className="w-full h-full max-w-7xl ui-frame no-padding flex overflow-hidden">
                            <div className="w-1/3 border-r border-[var(--border-color)] flex flex-col">
                                <header className="p-4 border-b border-[var(--border-color)] flex-shrink-0 flex justify-between items-center"><h2 className="text-xl font-bold text-slate-800">Bảng điều khiển</h2><button onClick={onLogout} className="secondary-btn px-3 py-1.5 text-sm">Đăng xuất</button></header>
                                
                                <div className="p-4 border-b border-[var(--border-color)] space-y-3">
                                    <h3 className="font-orbitron font-bold text-slate-700">KIỂM SOÁT HỆ THỐNG</h3>
                                    <div className="flex items-center justify-between">
                                        <span className={`font-semibold ${systemStatus.isOnline ? 'text-green-600' : 'text-slate-500'}`}>
                                            {systemStatus.isOnline ? 'Trạng thái: ONLINE' : 'Trạng thái: OFFLINE'}
                                        </span>
                                        <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" name="toggle" id="toggle" className="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" checked={systemStatus.isOnline} onChange={handleSystemStatusToggle}/>
                                            <label htmlFor="toggle" className="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                    <input 
                                        type="text"
                                        value={systemStatus.message}
                                        onChange={handleStatusMessageChange}
                                        placeholder="Nhập thông báo trạng thái..."
                                        className="w-full form-input text-sm p-2"
                                    />
                                </div>

                                <div className="p-4 border-b border-[var(--border-color)]"><h3 className="font-orbitron font-bold text-slate-700 mb-2">NGƯỜI DÙNG ONLINE ({onlineUsers.length})</h3><div className="max-h-32 overflow-y-auto custom-scrollbar space-y-2">{onlineUsers.map(user => (<div key={user.uid} className="flex items-center space-x-2 p-1 bg-slate-200/50 rounded-lg"><img src={user.avatarUrl} className="w-8 h-8 rounded-full" onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/32x32/e2e8f0/64748b?text=${(user.username || '?').charAt(0).toUpperCase()}`; }} /><span className="font-semibold text-sm text-slate-700">{user.username}</span></div>))}</div><button onClick={() => setShowBroadcastModal(true)} className="w-full primary-btn mt-3 text-sm py-2" style={{'--primary-color': 'var(--success-color)'}}>Gửi Thông Báo Chung</button></div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar">{conversations.map(conv => (<div key={conv.id} onClick={() => setCurrentChat(conv)} className={`p-4 cursor-pointer border-b border-slate-200 flex justify-between items-center transition-colors duration-200 ${currentChat?.id === conv.id ? 'bg-blue-100' : 'hover:bg-slate-100'}`}><div className="flex items-center space-x-3"><img src={conv.avatarUrl} className="w-10 h-10 rounded-full" onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/40x40/e2e8f0/64748b?text=${(conv.username || '?').charAt(0).toUpperCase()}`; }} /><div><p className="font-semibold text-slate-800">{conv.username}</p><p className="text-xs text-slate-500">ID: {conv.id.slice(0, 8)}...</p></div></div>{conv.isRead === false && conv.id !== currentChat?.id && <div className="w-3 h-3 bg-blue-500 rounded-full shadow-lg shadow-blue-500/50"></div>}</div>))}</div>
                            </div>
                            <div className="w-2/3 flex flex-col bg-slate-50">
                               {currentChat ? (
                                    <Fragment>
                                        <header className="p-4 border-b border-[var(--border-color)] flex-shrink-0 bg-white"><h2 className="text-xl font-bold text-slate-800">Kênh: {currentChat.username}</h2></header>
                                        <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">{messages.map(msg => <MessageRenderer key={msg.id} msg={msg} currentUser={currentUser} viewType="admin" editingMsg={editingMsg} onStartEdit={handleStartEdit} onSaveEdit={handleSaveEdit} onCancelEdit={handleCancelEdit} onUpdateEditingText={(text) => setEditingMsg({...editingMsg, text})} />)}<div ref={messagesEndRef} /></main>
                                        <footer className="p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-white space-y-3">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2"><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400 w-20">BÁO BÀN:</span><select value={selectedTable} onChange={e => setSelectedTable(e.target.value)} className="form-input text-sm py-1 px-2 w-full">{BACARAT_TABLES.map(table => <option key={table} value={table}>{table}</option>)}</select><button onClick={() => handleSendMessage('table_announcement', { table: selectedTable })} className="secondary-btn text-xs px-2 py-1 border-blue-500 text-blue-600 hover:bg-blue-50">Xác Nhận</button></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400 w-20">DỰ ĐOÁN:</span><button onClick={() => handleSendMessage('prediction', { prediction: 'Nhà Con', table: selectedTable })} className="flex-1 secondary-btn text-xs px-2 py-1 border-blue-500 text-blue-600 hover:bg-blue-50 font-bold">Con</button><button onClick={() => handleSendMessage('prediction', { prediction: 'Nhà Cái', table: selectedTable })} className="flex-1 secondary-btn text-xs px-2 py-1 border-red-500 text-red-600 hover:bg-red-50 font-bold">Cái</button><button onClick={() => handleSendMessage('prediction', { prediction: 'Hoà', table: selectedTable })} className="flex-1 secondary-btn text-xs px-2 py-1 border-green-500 text-green-600 hover:bg-green-50">Hoà</button></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400 w-20">PHẢN HỒI:</span><button onClick={() => handleSendMessage('result', { result: 'Thắng' })} className="flex-1 secondary-btn text-xs px-2 py-1 border-green-500 text-green-600 hover:bg-green-50">Thắng!</button><button onClick={() => handleSendMessage('result', { result: 'Thua' })} className="flex-1 secondary-btn text-xs px-2 py-1 border-red-500 text-red-600 hover:bg-red-50">Thua!</button></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400 w-20">VẼ CẦU:</span><button onClick={() => setShowGridModal(true)} className="secondary-btn text-xs px-2 py-1 border-slate-400 hover:bg-slate-50">Mở bảng</button></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400 w-20">HỆ THỐNG:</span><button onClick={() => handleSendMessage('wait', { text: 'Xin vui lòng đợi trong giây lát.'})} className="flex-1 secondary-btn text-xs px-2 py-1">Đợi lát</button></div></div>
                                            <div className="flex items-center gap-2 pt-3 border-t border-slate-200"><span className="text-xs font-bold text-slate-400 w-20">CẢNH BÁO:</span><input type="text" value={warningInput} onChange={e => setWarningInput(e.target.value)} placeholder="Nội dung cảnh báo tùy chỉnh..." className="form-input text-sm py-1 px-2 w-full" /><button onClick={handleSendWarning} disabled={!warningInput.trim()} className="secondary-btn text-xs px-4 py-2 border-amber-500 text-amber-600 hover:bg-amber-50">Gửi</button></div>
                                            <div className="flex items-center gap-2 pt-3 border-t border-red-200"><span className="text-xs font-bold text-red-600 w-20">TIN KHẨN:</span><input type="text" value={emergencyInput} onChange={e => setEmergencyInput(e.target.value)} placeholder="Nội dung khẩn cấp..." className="form-input text-sm py-1 px-2 w-full focus:border-red-500" /><button onClick={handleSendEmergency} disabled={!emergencyInput.trim()} className="primary-btn text-xs px-4 py-2" style={{'--primary-color': 'var(--danger-color)'}}>GỬI KHẨN</button></div>
                                            <div className="flex items-center space-x-2 pt-3 border-t border-slate-200"><input type="file" accept="image/*" ref={imageInputRef} onChange={handleImageUpload} style={{ display: 'none' }} /><button onClick={() => imageInputRef.current.click()} disabled={uploadingImage} className="secondary-btn p-2.5">{uploadingImage ? <svg className="animate-spin h-5 w-5 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>}</button><input value={inputMessage} onChange={handleTyping} onKeyPress={e => { if(e.key === 'Enter') handleSendMessage() }} type="text" placeholder="Phản hồi..." className="w-full form-input" /><button onClick={() => handleSendMessage()} className="primary-btn px-6">Gửi</button></div>
                                        </footer>
                                        {/* FUTURE GRID – MODAL */}
                                        <AnimatedPresence isVisible={showGridModal}>
                                          <Modal onClose={() => setShowGridModal(false)} size="3xl">
                                            <h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Vẽ Cầu</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                              <div>
                                                <label className="block text-sm font-semibold mb-1 text-slate-600">Sảnh</label>
                                                <select value={gridInfo.lobby} onChange={e=>setGridInfo(v=>({...v, lobby:e.target.value}))} className="form-input w-full">
                                                  <option value="DG">DG</option>
                                                  <option value="SEXY">SEXY</option>
                                                </select>
                                              </div>
                                              <div className="md:col-span-2">
                                                <label className="block text-sm font-semibold mb-1 text-slate-600">Tên bàn</label>
                                                <input value={gridInfo.tableName} onChange={e=>setGridInfo(v=>({...v, tableName:e.target.value}))} className="form-input w-full" placeholder="Ví dụ: BACARAT C04" />
                                              </div>
                                            </div>
                                            <div className="overflow-auto max-h-[60vh]">
                                              <div style={{ display: 'grid', gridTemplateColumns: `repeat(${gridData[0]?.length || 12}, 20px)` }}>
                                                {gridData.flatMap((row, r) =>
                                                  row.map((cell, c) => (
                                                    <div key={`${r}-${c}`}
                                                         onClick={() => cycleCell(r,c)}
                                                         onContextMenu={(e)=>{e.preventDefault(); clearCell(r,c);}}
                                                         style={{ width: '22px', height: '22px', border: '1px solid #e5e7eb', cursor: 'pointer',
                                                                  borderRadius: '9999px', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                                  backgroundColor: cell === 'P' ? '#2563eb' : (cell === 'B' ? '#dc2626' : 'white'),
                                                                  color: (cell === 'P' || cell === 'B') ? 'white' : 'transparent', fontSize: '12px', fontWeight: 700 }}
                                                    />
                                                  ))
                                                )}
                                              </div>
                                            </div>
                                            <div className="flex justify-end gap-3 mt-4">
                                              <button onClick={()=>setShowGridModal(false)} className="secondary-btn px-4 py-2">Đóng</button>
                                              <button onClick={sendFutureGrid} className="primary-btn px-4 py-2">Gửi cho User</button>
                                            </div>
                                          </Modal>
                                        </AnimatedPresence>
        
                                    </Fragment>
                               ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-slate-400 space-y-4"><svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1"><path strokeLinecap="round" strokeLinejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><p className="text-xl">Chọn một kênh liên lạc để bắt đầu</p></div>
                               )}
                            </div>
                        </div>
                    </div>
                    <AnimatedPresence isVisible={showBroadcastModal}><Modal onClose={() => setShowBroadcastModal(false)}><h3 className="text-2xl font-bold text-center mb-4 text-slate-800">Gửi Thông Báo Chung</h3><p className="text-center text-sm text-slate-500 mb-4">Tin nhắn này sẽ được gửi đến tất cả {conversations.length} người dùng.</p><textarea value={broadcastMessage} onChange={e => setBroadcastMessage(e.target.value)} className="w-full h-32 p-3 form-input" placeholder="Nội dung thông báo..."></textarea><div className="flex justify-end space-x-4 mt-4"><button onClick={() => setShowBroadcastModal(false)} className="secondary-btn px-4 py-2">Hủy</button><button onClick={handleBroadcast} disabled={!broadcastMessage.trim()} className="primary-btn px-4 py-2" style={{'--primary-color': 'var(--success-color)'}}>Gửi Đi</button></div></Modal></AnimatedPresence>
                 </Fragment>
            );
        };

        const System = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isSplashVisible, setIsSplashVisible] = useState(true);

            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsSplashVisible(false);
                    sfx.boot();
                }, 3000);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const raw = userDocSnap.data();
                            const fallbackUsername = (user.email || '').split('@')[0] || 'user';
                            const username = raw?.username || fallbackUsername;
                            const avatarUrl = raw?.avatarUrl || `https://placehold.co/96x96/e2e8f0/64748b?text=${username.charAt(0).toUpperCase()}`;
                            const userStatusRef = ref(rtdb, '/status/' + user.uid);
                            const isOnline = { isOnline: true, lastSeen: rtdbServerTimestamp(), username, avatarUrl };
                            const isOffline = { isOnline: false, lastSeen: rtdbServerTimestamp(), username, avatarUrl };
                            onValue(ref(rtdb, '.info/connected'), (snapshot) => {
                                if (snapshot.val() === false) return;
                                onDisconnect(userStatusRef).set(isOffline).then(() => set(userStatusRef, isOnline));
                            });
                        }
                    }
                    setCurrentUser(user);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => {
                sfx.logout();
                if (auth.currentUser) {
                    const userStatusRef = ref(rtdb, '/status/' + auth.currentUser.uid);
                    update(userStatusRef, { isOnline: false, lastSeen: rtdbServerTimestamp() });
                }
                signOut(auth).catch(error => { console.error("Lỗi khi đăng xuất:", error); });
            };
            
            const renderContent = () => {
                if (isLoading) {
                    return null;
                }
                if (!currentUser) {
                    return <LoginScreen />;
                }
                const isAdmin = currentUser.email.split('@')[0] === ADMIN_USERNAME;
                return isAdmin 
                    ? <AdminDashboard currentUser={currentUser} onLogout={handleLogout} /> 
                    : <UserView currentUser={currentUser} onLogout={handleLogout} />;
            };

            return (
                <Fragment>
                    <AnimatedPresence isVisible={isSplashVisible}>
                        <SplashScreen />
                    </AnimatedPresence>
                    
                    <div className={`h-full w-full ${isSplashVisible ? 'opacity-0' : 'opacity-100 transition-opacity duration-500'}`}>
                        {renderContent()}
                    </div>
                </Fragment>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<System />);
    </script>

    <audio id="bgm" src="Elden Ring Main Theme (The Final Battle) - EPIC VERSION (1).mp3" loop preload="auto"></audio>
    <script>
      (function(){
        const bgm = document.getElementById('bgm');
        if (!bgm) return;
        bgm.volume = 0.25;
        const tryPlay = () => { bgm.play().catch(()=>{}); };
        // Start after first user interaction
        window.addEventListener('click', tryPlay, { once: true });
        window.addEventListener('keydown', tryPlay, { once: true });
        // Also attempt after 3.5s splash ends
        setTimeout(tryPlay, 3500);
      })();
    </script>


<!-- Safety patch: prevent full-page reloads -->
<script>
window.addEventListener('DOMContentLoaded', () => {
  // Apply admin theme to whole page (simple)
  document.body.classList.add('admin-theme');

  // Prevent any form submit from reloading
  document.querySelectorAll('form').forEach(f => {
    f.addEventListener('submit', e => { e.preventDefault(); return false; });
  });
  // Default buttons to non-submit
  document.querySelectorAll('button:not([type])').forEach(btn => btn.setAttribute('type','button'));
  document.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(el => {
    el.setAttribute('data-original-type','submit');
    if (el.tagName === 'BUTTON') el.setAttribute('type','button');
    if (el.tagName === 'INPUT')  el.setAttribute('type','button');
  });
  // Disable dead anchors
  document.querySelectorAll('a[href="#"], a[href=""]').forEach(a => {
    a.addEventListener('click', e => e.preventDefault());
  });
});
</script>

</body>
</html>
